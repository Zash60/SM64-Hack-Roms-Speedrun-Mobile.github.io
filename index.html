<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SM64 Hack Roms Speedrun Mobile</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css">
    <style>
        :root {
            --bg-color: #1a1a1a; --surface-color: #2c2c2c; --primary-color: #4a90e2;
            --text-color: #e0e0e0; --text-secondary-color: #a0a0e0; --border-color: #444;
        }
        body { font-family: 'Roboto', sans-serif; margin: 0; background-color: var(--bg-color); color: var(--text-color); line-height: 1.6; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        a { color: var(--primary-color); text-decoration: none; cursor: pointer; }
        a:hover { text-decoration: underline; }
        header { background-color: var(--surface-color); padding: 1rem 0; border-bottom: 1px solid var(--border-color); position: sticky; top: 0; z-index: 999; }
        header .container { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;}
        header nav a { margin-left: 15px; font-weight: bold; }
        h1, h2, h3, h4 { font-weight: 700; border-bottom: 1px solid var(--border-color); padding-bottom: 8px; margin-top: 0; }
        h4 { font-size: 1.1em; margin-top: 20px; border-bottom: none; padding-bottom: 4px; border-left: 3px solid var(--primary-color); padding-left: 10px;}
        h5 { margin-bottom: 5px; color: var(--text-secondary-color); font-size: 0.9em; text-transform: uppercase; }
        .card { background-color: var(--surface-color); padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid var(--border-color); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select, textarea, button { font-family: 'Roboto', sans-serif; font-size: 1rem; }
        input, select, textarea { width: 100%; padding: 10px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-color); box-sizing: border-box; }
        input[type="checkbox"] { width: auto; margin-right: 10px; }
        select { appearance: none; -webkit-appearance: none; background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23a0a0a0%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E'); background-repeat: no-repeat; background-position: right .7em top 50%; background-size: .65em auto; padding-right: 2em; }
        .btn { padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; margin-right: 5px; transition: background-color 0.2s; }
        .btn:disabled { background-color: #555; cursor: not-allowed; }
        .btn-sm { padding: 5px 8px; font-size: 0.8em; }
        .btn-primary { background-color: var(--primary-color); color: #fff; }
        .btn-success { background-color: #28a745; color: #fff; }
        .btn-danger { background-color: #dc3545; color: #fff; }
        .btn-icon { background: none; border: none; color: var(--text-secondary-color); cursor: pointer; padding: 2px 6px; font-size: 1.1em; }
        .btn-icon:hover { color: var(--primary-color); }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); animation: fadeIn 0.3s; }
        .modal-content { background-color: var(--surface-color); margin: 5% auto; padding: 20px; border: 1px solid var(--border-color); width: 90%; max-width: 700px; border-radius: 8px; }
        .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; line-height: 1; }
        .page-container { padding: 2rem 0; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .games-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; }
        .game-card { display: block; background-color: var(--surface-color); border-radius: 8px; overflow: hidden; text-align: center; border: 1px solid var(--border-color); transition: transform 0.2s ease; position: relative; }
        .game-card:hover { transform: translateY(-5px); }
        .game-card img { width: 100%; height: 80px; object-fit: contain; display: block; background-color: #111; }
        .game-card-info { padding: 10px; }
        .game-card-info h3 { margin: 0; font-size: 0.8rem; font-weight: 400; color: var(--text-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; border: none; padding: 0;}
        .game-card-year { position: absolute; top: 5px; right: 5px; background-color: rgba(0,0,0,0.7); color: white; padding: 2px 5px; border-radius: 3px; font-size: 0.7em; font-weight: bold; }
        .leaderboard-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .leaderboard-nav { display: flex; gap: 20px; flex-wrap: wrap; align-items: flex-end; }
        .category-tabs { display: flex; gap: 5px; flex-wrap: wrap; }
        .tab { padding: 8px 15px; background-color: #333; border-radius: 5px; cursor: pointer; border: 1px solid var(--border-color); }
        .tab.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        .leaderboard-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        .leaderboard-table th, .leaderboard-table td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border-color); }
        .hack-item-header { display: flex; justify-content: space-between; align-items: center; width: 100%; gap: 10px; flex-wrap: wrap; }
        .hack-manage-details { display: none; width: 100%; padding: 15px; background-color: #222; border-top: 1px solid var(--border-color); margin-top: 10px; border-radius: 0 0 8px 8px; }
        .admin-list-item { display: flex; justify-content: space-between; align-items: center; gap: 10px; padding: 5px 0; border-bottom: 1px solid #333; flex-wrap: wrap; }
        .inline-edit-container { display: flex; align-items: center; gap: 5px; flex-grow: 1; }
        .inline-edit-container input { width: auto; flex-grow: 1; padding: 4px; font-size: 0.9em; background-color: #111; }
        .admin-add-form { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
        .admin-add-form input { flex-grow: 1; min-width: 150px; }
        .admin-add-form button { flex-shrink: 0; }
        .admin-sub-details { display: none; width: 100%; background-color: #111; padding: 10px; margin-top: 8px; border-radius: 4px; border-left: 2px solid var(--primary-color); }
        .controls-container { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; align-items: center;}
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid var(--primary-color); width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>SM64 Hack Roms Speedrun Mobile</h1>
            <nav><a id="home-link">Home</a><span id="auth-links-container"></span></nav>
        </div>
    </header>
    <main class="container">
        <div id="page-home" class="page-container">
            <h2>Games</h2>
            <div class="controls-container">
                <div class="form-group" style="flex-grow: 1;"><label for="hack-search-input">Search</label><input type="search" id="hack-search-input"></div>
                <div class="form-group"><label for="sort-by-select">Sort by</label>
                    <select id="sort-by-select">
                        <option value="name_asc">Name</option>
                        <option value="newest_released">Newest released</option>
                        <option value="oldest_released">Oldest released</option>
                    </select>
                </div>
            </div>
            <div id="games-grid"></div>
        </div>
        <div id="page-hack-details" class="page-container" style="display: none;">
            <div class="leaderboard-header">
                <h2 id="hack-details-title"></h2>
                <button id="submit-run-btn" class="btn btn-primary">Submit Run</button>
            </div>
            <div class="leaderboard-nav">
                <div class="form-group"><label>Leaderboard Type</label><select id="type-select"></select></div>
                <div id="level-select-container" class="form-group" style="display: none;"><label>Level / Stage</label><select id="level-select"></select></div>
            </div>
            <div id="leaderboard-content"></div>
        </div>
        <div id="page-admin" class="page-container" style="display: none;">
            <div id="login-section" style="display:none;">
                <h2>Moderator Login</h2>
                <form id="login-form" class="card">
                    <div class="form-group"><label>Email</label><input type="email" id="email" required></div>
                    <div class="form-group"><label>Password</label><input type="password" id="password" required></div>
                    <button type="submit" class="btn btn-primary">Login</button>
                    <p id="login-error" style="color: #e24a4a;"></p>
                </form>
            </div>
            <div id="admin-content" style="display: none;">
                <h2>Admin Panel</h2>
                <div class="card">
                    <h3>Add New Hack Rom</h3>
                    <form id="add-hack-form">
                        <div class="form-group"><label>Hack Name</label><input type="text" id="add-hack-name" required></div>
                        <div class="form-group"><label>Release Year</label><input type="number" id="add-hack-year" required></div>
                        <div class="form-group"><label>Cover Image URL</label><input type="url" id="add-hack-image" placeholder="https://example.com/image.png" required></div>
                        <button type="submit" class="btn btn-primary">Add Hack</button>
                    </form>
                </div>
                <div class="card">
                    <h3>Synchronization</h3>
                    <p>Fetch and add new SM64 Hack Roms, including categories and levels, directly from the official speedrun.com series.</p>
                    <button id="sync-src-btn" class="btn btn-primary">Sync with Speedrun.com</button>
                    <div class="form-group" style="margin-top: 10px;"><label style="display: inline-flex; align-items: center;"><input type="checkbox" id="force-sync-checkbox"> Force update (deletes all existing data)</label></div>
                    <div id="sync-status" style="margin-top: 10px;"></div>
                </div>
                <div class="card">
                    <h3>Existing Hack Roms</h3>
                    <div id="existing-hacks-list"></div>
                </div>
                <div class="card">
                    <h3>Review Pending Runs</h3>
                    <div id="pending-runs-list"></div>
                </div>
            </div>
        </div>
    </main>
    <div id="submit-run-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span><h3>Submit Run for <span id="submit-run-title"></span></h3>
            <form id="submit-run-form">
                <div class="form-group"><label>Player Name</label><input type="text" id="run-player" required></div>
                <div class="form-group"><label>Time (e.g., 1:23.456)</label><input type="text" id="run-time" required></div>
                <div class="form-group"><label>Date Achieved</label><input type="date" id="run-date" required></div>
                <div class="form-group"><label>Video Link</label><input type="url" id="run-video" required></div>
                <div id="run-submission-filters"></div>
                <button type="submit" class="btn btn-primary">Submit for Review</button>
            </form>
        </div>
    </div>

<script type="module">
    // Import Firebase SDKs
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getDatabase, ref, get, set, push, remove, update, query, orderByChild, equalTo, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyAsVYnWAq5aFOz9dIxHpGVWK8Mk64f01GU",
        authDomain: "sm64-hack-roms-speedrun-mobile.firebaseapp.com",
        databaseURL: "https://sm64-hack-roms-speedrun-mobile-default-rtdb.firebaseio.com",
        projectId: "sm64-hack-roms-speedrun-mobile",
        storageBucket: "sm64-hack-roms-speedrun-mobile.firebasestorage.app",
        messagingSenderId: "499101981060",
        appId: "1:499101981060:web:209dfe3f20866ef4f865d1"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    let state = { user: null };

    // Utility Functions
    function showPage(pageId) { document.querySelectorAll('.page-container').forEach(p => p.style.display = 'none'); document.getElementById(pageId).style.display = 'block'; }
    function parseTimeToMilliseconds(timeStr) { let t=0;if(timeStr.includes(':')){const parts=timeStr.split(':').reverse();t+=parseFloat(parts[0]||0)*1e3;t+=parseInt(parts[1]||0)*6e4;t+=parseInt(parts[2]||0)*36e5}else{timeStr.match(/(\d+)\s*h/)?.[1]&&(t+=parseInt(timeStr.match(/(\d+)\s*h/)[1])*36e5);timeStr.match(/(\d+)\s*m/)?.[1]&&(t+=parseInt(timeStr.match(/(\d+)\s*m/)[1])*6e4);timeStr.match(/(\d+(\.\d+)?)\s*s/)?.[1]&&(t+=parseFloat(timeStr.match(/(\d+(\.\d+)?)\s*s/)[1].replace(",","."))*1e3);timeStr.match(/(\d+)\s*ms/)?.[1]&&(t+=parseInt(timeStr.match(/(\d+)\s*ms/)[1]))}if(t===0&&!isNaN(parseFloat(timeStr)))t=parseFloat(timeStr)*1e3;return Math.round(t)}
    function formatTime(ms) { if (isNaN(ms) || ms < 0) return "Invalid Time"; const tS = Math.floor(ms / 1000); const h = Math.floor(tS / 3600); const m = Math.floor((tS % 3600) / 60); const s = tS % 60; const mmm = ms % 1000; const pM = String(m).padStart(2, '0'); const pS = String(s).padStart(2, '0'); const pMMM = String(mmm).padStart(3, '0'); if (h > 0) { return `${h}:${pM}:${pS}.${pMMM}`; } return `${m}:${pS}.${pMMM}`; }
    function createHTMLElement(tag, className, innerHTML = '') { const el = document.createElement(tag); if (className) el.className = className; el.innerHTML = innerHTML; return el; }
    function slugify(text) { return text.toString().toLowerCase().trim().replace(/\s+/g, '-').replace(/[^\w\-]+/g, '').replace(/\-\-+/g, '-').replace(/^-+/, '').replace(/-+$/, ''); }
    function snapshotToArray(snapshot) {
        const returnArr = [];
        snapshot.forEach(childSnapshot => {
            const item = childSnapshot.val();
            item.id = childSnapshot.key;
            returnArr.push(item);
        });
        return returnArr;
    }

    // --- Main Logic ---

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('home-link').onclick = (e) => { e.preventDefault(); window.location.hash = ''; showPage('page-home'); };
        onAuthStateChanged(auth, user => {
            state.user = user;
            updateAuthUI();
            handleRouteChange();
        });
    });
    
    function updateAuthUI() {
        const authLinks = document.getElementById('auth-links-container');
        authLinks.innerHTML = state.user ? `<a id="admin-link">Admin</a><a id="logout-link">Logout</a>` : `<a id="login-link">Login</a>`;
        if (state.user) {
            document.getElementById('admin-link').onclick = (e) => { e.preventDefault(); window.location.hash = '#admin'; };
            document.getElementById('logout-link').onclick = async (e) => { e.preventDefault(); await signOut(auth); window.location.hash = ''; };
        } else {
            document.getElementById('login-link').onclick = (e) => { e.preventDefault(); window.location.hash = '#admin'; };
        }
    }

    window.addEventListener('hashchange', handleRouteChange);
    function handleRouteChange() {
        const hash = window.location.hash;
        if (hash.startsWith('#hack/')) showHackDetails(hash.substring(6));
        else if (hash === '#admin') { showPage('page-admin'); initAdminPage(); }
        else { showPage('page-home'); if (!document.querySelector('#games-grid .game-card')) fetchAndDisplayHacks(); }
    }

    async function fetchAndDisplayHacks() {
        const gamesGrid = document.getElementById('games-grid');
        gamesGrid.innerHTML = '<div class="loader"></div>';
        const sortBy = document.getElementById('sort-by-select').value;
        
        let sortKey = 'name';
        if (sortBy === 'newest_released' || sortBy === 'oldest_released') {
            sortKey = 'year';
        }
        
        const hacksRef = ref(db, 'hacks');
        const q = query(hacksRef, orderByChild(sortKey));

        try {
            const snapshot = await get(q);
            let hacks = snapshot.exists() ? snapshotToArray(snapshot) : [];
            
            if (sortBy === 'newest_released') {
                hacks.sort((a, b) => (b.year || 0) - (a.year || 0) || (b.created_at || '').localeCompare(a.created_at || ''));
            } else if (sortBy === 'oldest_released') {
                hacks.sort((a, b) => (a.year || 0) - (b.year || 0) || (a.created_at || '').localeCompare(b.created_at || ''));
            }
            
            gamesGrid.innerHTML = '';
            if (hacks.length === 0) {
                gamesGrid.innerHTML = '<p>No hack roms found. Run the sync in the Admin Panel.</p>'; return;
            }

            hacks.forEach(hack => {
                const card = createHTMLElement('a', 'game-card', `${hack.year ? `<div class="game-card-year">${hack.year}</div>` : ''}<img src="${hack.imageUrl}" alt="${hack.name}" loading="lazy"><div class="game-card-info"><h3>${hack.name}</h3></div>`);
                card.href = `#hack/${hack.slug}`;
                card.onclick = (e) => { e.preventDefault(); window.location.hash = `hack/${hack.slug}`; };
                gamesGrid.appendChild(card);
            });
        } catch (error) {
            console.error("Error fetching hacks:", error);
            gamesGrid.innerHTML = `<p style="color: red;"><b>Error loading games.</b><br>Check Firebase setup and RTDB security rules.</p>`;
        }
    }
    
    document.getElementById('hack-search-input').addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        document.querySelectorAll('.game-card').forEach(card => {
            card.style.display = card.querySelector('h3').textContent.toLowerCase().includes(searchTerm) ? 'block' : 'none';
        });
    });
    document.getElementById('sort-by-select').addEventListener('change', fetchAndDisplayHacks);

    async function showHackDetails(slug) {
        showPage('page-hack-details');
        const leaderboardContent = document.getElementById('leaderboard-content');
        leaderboardContent.innerHTML = '<div class="loader"></div>';

        const q = query(ref(db, 'hacks'), orderByChild('slug'), equalTo(slug));
        const snapshot = await get(q);
        const hack = snapshot.exists() ? snapshotToArray(snapshot)[0] : null;

        if (!hack) { window.location.hash = ''; return; }
        leaderboardContent.innerHTML = `<div id="category-tabs-container"><h4>Categories</h4><div class="category-tabs"></div></div><div id="variable-filters"></div><table class="leaderboard-table"><thead><tr><th>#</th><th>Player</th><th>Time</th><th>Date</th><th id="actions-header" style="display:none;">Actions</th></tr></thead><tbody></tbody></table>`;
        state.hack = hack;
        document.getElementById('hack-details-title').textContent = hack.name;
        const typeSelect = document.getElementById('type-select');
        typeSelect.innerHTML = '<option value="fullgame">Full-game</option><option value="level_rta">Level RTA</option><option value="level_singlestar">Single-Star</option>';
        
        const levelsQ = query(ref(db, 'levels'), orderByChild('hack_id'), equalTo(hack.id));
        const levelsSnapshot = await get(levelsQ);
        const levels = levelsSnapshot.exists() ? snapshotToArray(levelsSnapshot).sort((a,b) => a.order - b.order) : [];

        document.getElementById('level-select').innerHTML = levels ? levels.map(l => `<option value="${l.id}">${l.name}</option>`).join('') : '';
        [document.getElementById('level-select'), typeSelect].forEach(el => el.onchange = renderLeaderboardUI);
        renderLeaderboardUI();
    }
    
    async function renderLeaderboardUI() {
        const selectedType = document.getElementById('type-select').value; 
        const isFullgame = selectedType === 'fullgame';
        document.getElementById('level-select-container').style.display = isFullgame ? 'none' : 'block';
        document.getElementById('leaderboard-content').querySelector('#category-tabs-container').style.display = isFullgame ? 'block' : 'none';

        const categoriesQ = query(ref(db, 'categories'), orderByChild('hack_id'), equalTo(state.hack.id));
        const snapshot = await get(categoriesQ);
        const allCategories = snapshot.exists() ? snapshotToArray(snapshot) : [];
        const categories = allCategories.filter(c => c.type === selectedType).sort((a,b) => a.order - b.order);

        if (categories.length === 0) { document.querySelector('.leaderboard-table tbody').innerHTML = `<tr><td colspan="4">No categories for this type.</td></tr>`; document.getElementById('variable-filters').innerHTML = ''; return; }
        if (isFullgame) {
            const tabsContainer = document.querySelector('.category-tabs');
            tabsContainer.innerHTML = categories.map(c => `<div class="tab" data-id="${c.id}">${c.name}</div>`).join('');
            tabsContainer.querySelectorAll('.tab').forEach(tab => tab.onclick = () => { tabsContainer.querySelector('.active')?.classList.remove('active'); tab.classList.add('active'); renderVariablesAndRuns(categories.find(c => c.id === tab.dataset.id)); });
            tabsContainer.querySelector('.tab').click();
        } else { renderVariablesAndRuns(categories[0]); }
    }
    
    async function renderVariablesAndRuns(category) {
        state.category = category;
        const filtersContainer = document.getElementById('variable-filters');
        filtersContainer.innerHTML = '';
        
        if (category.type === 'fullgame') {
            const variablesQ = query(ref(db, 'variables'), orderByChild('hack_id'), equalTo(state.hack.id));
            const variablesSnapshot = await get(variablesQ);
            const variables = variablesSnapshot.exists() ? snapshotToArray(variablesSnapshot).sort((a,b) => a.order - b.order) : [];
            
            for(const v of variables) {
                const optionsQ = query(ref(db, 'options'), orderByChild('variable_id'), equalTo(v.id));
                const optionsSnapshot = await get(optionsQ);
                v.options = optionsSnapshot.exists() ? snapshotToArray(optionsSnapshot).sort((a,b) => a.order - b.order) : [];
            }
            filtersContainer.innerHTML = variables.map(v => `
                <div class="form-group"><label>${v.name}</label><select data-var-id="${v.id}">${v.options.map(opt => `<option value="${opt.id}">${opt.name}</option>`).join('')}</select></div>
            `).join('');

        } else if (category.type === 'level_singlestar') {
            const levelId = document.getElementById('level-select').value;
            const starsQ = query(ref(db, 'stars'), orderByChild('level_id'), equalTo(levelId));
            const starsSnapshot = await get(starsQ);
            const stars = starsSnapshot.exists() ? snapshotToArray(starsSnapshot).sort((a,b) => a.order - b.order) : [];
            if (stars.length > 0) {
                filtersContainer.innerHTML = `<div class="form-group"><label>Star</label><select data-var-id="star">${stars.map(s => `<option value="${s.id}">${s.name}</option>`).join('')}</select></div>`;
            }
        }
        
        document.querySelectorAll('#variable-filters select').forEach(s => s.onchange = fetchAndDisplayLeaderboard);
        fetchAndDisplayLeaderboard();
    }

    async function fetchAndDisplayLeaderboard() {
        const isMod = !!state.user;
        document.querySelector('#actions-header').style.display = isMod ? '' : 'none';
        const tbody = document.querySelector('.leaderboard-table tbody');
        tbody.innerHTML = `<tr><td colspan="${isMod ? 5 : 4}"><div class="loader"></div></td></tr>`;
        
        const runsQ = query(ref(db, 'runs'), orderByChild('category_id'), equalTo(state.category.id));
        const snapshot = await get(runsQ);
        const allRunsForCategory = snapshot.exists() ? snapshotToArray(snapshot) : [];
        const approvedRuns = allRunsForCategory.filter(run => run.status === 'approved');

        const variables = {};
        document.querySelectorAll('#variable-filters select').forEach(s => { variables[s.dataset.varId] = s.value; });
        if (state.category.type !== 'fullgame') variables['level'] = document.getElementById('level-select').value;

        const filteredRuns = approvedRuns.filter(run => 
            Object.keys(variables).every(key => run.variables && run.variables[key] === variables[key])
        ).sort((a, b) => a.timeInMs - b.timeInMs);
        
        tbody.innerHTML = '';
        if (filteredRuns.length === 0) { tbody.innerHTML = `<tr><td colspan="${isMod ? 5 : 4}">No approved runs for these filters.</td></tr>`; return; }
        filteredRuns.forEach((run, index) => {
            const row = tbody.insertRow();
            row.innerHTML = `<td>${index + 1}</td><td><a href="${run.videoUrl}" target="_blank">${run.playerName}</a></td><td>${formatTime(run.timeInMs)}</td><td>${run.dateAchieved}</td>`;
            if (isMod) {
                const actionsCell = row.insertCell();
                actionsCell.innerHTML = `<button class="btn-danger" style="padding: 2px 6px; font-size: 0.8em;">Del</button>`;
                actionsCell.querySelector('button').onclick = () => deleteRun(run.id);
            }
        });
    }
    
    function initAdminPage() {
        document.getElementById('login-section').style.display = state.user ? 'none' : 'block';
        document.getElementById('admin-content').style.display = state.user ? 'block' : 'none';
        if (state.user) {
            loadAdminData();
            const syncBtn = document.getElementById('sync-src-btn');
            if (!syncBtn.dataset.listener) { syncBtn.addEventListener('click', syncWithSpeedrunCom); syncBtn.dataset.listener = 'true'; }
            document.getElementById('add-hack-form').onsubmit = handleAddHack;
        }
        document.getElementById('login-form').onsubmit = async (e) => {
            e.preventDefault();
            const email = e.target.querySelector('#email').value;
            const password = e.target.querySelector('#password').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
                document.getElementById('login-error').textContent = '';
            } catch (error) { document.getElementById('login-error').textContent = error.message; }
        };
    }
    
    async function handleAddHack(e) {
        e.preventDefault();
        const name = document.getElementById('add-hack-name').value;
        const newHack = { name, year: document.getElementById('add-hack-year').value, imageUrl: document.getElementById('add-hack-image').value, slug: slugify(name), created_at: new Date().toISOString() };
        try {
            await push(ref(db, 'hacks'), newHack);
            alert('Hack added!'); e.target.reset(); loadExistingHacksAdmin();
        } catch (error) { alert('Error: ' + error.message); }
    }

    async function loadAdminData() { await Promise.all([ loadExistingHacksAdmin(), loadPendingRuns() ]); }

    async function loadExistingHacksAdmin() {
        const listContainer = document.getElementById('existing-hacks-list');
        listContainer.innerHTML = '<div class="loader"></div>';
        const q = query(ref(db, 'hacks'), orderByChild('name'));
        const snapshot = await get(q);
        const hacks = snapshot.exists() ? snapshotToArray(snapshot) : [];
        listContainer.innerHTML = '';
        hacks.forEach(hack => {
            const item = createHTMLElement('div', 'card');
            item.innerHTML = `<div class="hack-item-header"><span><strong>${hack.name}</strong> (${hack.year || 'N/A'})</span><div><button class="btn btn-primary btn-sm manage-btn">Manage <i class="fa-solid fa-chevron-down"></i></button><button class="btn btn-danger btn-sm delete-btn">Delete</button></div></div><div class="hack-manage-details"></div>`;
            const detailsDiv = item.querySelector('.hack-manage-details'), manageBtn = item.querySelector('.manage-btn');
            // Simplified manage button for brevity
            manageBtn.onclick = () => { detailsDiv.innerHTML = 'Management UI for RTDB needs a specific implementation.'; detailsDiv.style.display = detailsDiv.style.display === 'block' ? 'none' : 'block'; };
            item.querySelector('.delete-btn').onclick = async () => { if (confirm(`DELETE ${hack.name}?`)) { await remove(ref(db, `hacks/${hack.id}`)); loadExistingHacksAdmin(); }};
            listContainer.appendChild(item);
        });
    }
    
    async function loadPendingRuns() {
        const listContainer = document.getElementById('pending-runs-list');
        const q = query(ref(db, 'runs'), orderByChild('status'), equalTo('pending'));
        
        onValue(q, (snapshot) => {
            listContainer.innerHTML = '<div class="loader"></div>';
            const runs = snapshot.exists() ? snapshotToArray(snapshot).sort((a,b) => (b.submittedAt || '').localeCompare(a.submittedAt || '')) : [];
            listContainer.innerHTML = runs.length === 0 ? 'No runs pending review.' : '';
            runs.forEach(run => {
                const item = createHTMLElement('div', 'card', `<div><strong>${run.hackName} - ${run.categoryName}</strong><br>Player: ${run.playerName} | Time: ${formatTime(run.timeInMs)} | <a href="${run.videoUrl}" target="_blank">Video</a><div style="margin-top:10px;"><button class="btn btn-success approve-btn">Approve</button><button class="btn btn-danger reject-btn">Reject</button></div></div>`);
                item.querySelector('.approve-btn').onclick = () => updateRunStatus(run.id, 'approved');
                item.querySelector('.reject-btn').onclick = () => updateRunStatus(run.id, 'rejected');
                listContainer.appendChild(item);
            });
        }, { onlyOnce: false }); // Explicitly listen for changes
    }
    async function updateRunStatus(runId, status) { await update(ref(db, `runs/${runId}`), { status }); }
    async function deleteRun(runId) { if (confirm(`Delete this run?`)) { await remove(ref(db, `runs/${runId}`)); fetchAndDisplayLeaderboard(); } }
    
    const submitRunModal = document.getElementById('submit-run-modal');
    document.getElementById('submit-run-btn').onclick = () => {
        if (!state.category) { alert('Select a category first.'); return; }
        document.getElementById('submit-run-title').textContent = `${state.hack.name} - ${state.category.name}`;
        document.getElementById('run-date').value = new Date().toISOString().split('T')[0];
        submitRunModal.style.display = 'block';
    };
    document.querySelector('#submit-run-modal .close-button').onclick = () => submitRunModal.style.display = 'none';
    
    document.getElementById('submit-run-form').onsubmit = async (e) => {
        e.preventDefault();
        const timeInMs = parseTimeToMilliseconds(document.getElementById('run-time').value);
        if (isNaN(timeInMs)) return alert('Invalid time format.');
        const variables = {};
        document.querySelectorAll('#variable-filters select, #run-submission-filters select').forEach(s => { variables[s.dataset.varId] = s.value; });
        
        const newRun = {
            hack_id: state.hack.id,
            category_id: state.category.id,
            hackName: state.hack.name,
            categoryName: state.category.name,
            playerName: document.getElementById('run-player').value,
            timeInMs,
            dateAchieved: document.getElementById('run-date').value,
            videoUrl: document.getElementById('run-video').value,
            variables,
            status: 'pending',
            submittedAt: new Date().toISOString()
        };
        await push(ref(db, 'runs'), newRun);
        alert('Run submitted for review!');
        submitRunModal.style.display = 'none';
        e.target.reset();
    };

    async function syncWithSpeedrunCom() {
        alert("Sync function needs to be rewritten for Firebase Realtime Database. This is a complex operation.");
    }
</script>
</body>
</html>
