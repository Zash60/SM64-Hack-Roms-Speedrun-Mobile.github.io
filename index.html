<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SM64 ROM Hacks Speedruns</title>
    <style>
        :root {
            --bg-color: #18181b; --card-color: #27272a; --text-color: #e4e4e7;
            --primary-color: #3b82f6; --border-color: #3f3f46; --danger-color: #ef4444;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-color); color: var(--text-color); margin: 0;
        }
        .container { max-width: 900px; margin: 0 auto; padding: 1rem; }
        .view { display: none; }
        nav {
            display: flex; justify-content: space-between; align-items: center; padding: 1rem;
            background-color: var(--card-color); border-bottom: 1px solid var(--border-color);
        }
        nav a { color: var(--text-color); text-decoration: none; font-weight: 500; padding: 0.5rem; }
        nav a.active { color: var(--primary-color); border-bottom: 2px solid var(--primary-color); }
        h3, h4 { border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; margin-top: 0; }
        .category-buttons { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1.5rem; }
        .category-buttons button { background-color: var(--bg-color); color: var(--text-color); border: 1px solid var(--border-color); padding: 0.8rem; border-radius: 6px; font-size: 1rem; cursor: pointer; }
        .category-buttons button.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        /* Outros estilos permanecem os mesmos */
    </style>
</head>
<body>
    <!-- A estrutura do nav e do container é a mesma -->
    <nav>...</nav>
    <div class="container">
        <!-- Views de Login, Home e Admin são as mesmas -->
        <div id="login-view" class="view">...</div>
        <div id="home-view" class="view">...</div>
        <div id="admin-view" class="view">...</div>

        <div id="leaderboard-view" class="view">
            <h2 id="leaderboard-game-title"></h2>
            <div class="card" id="leaderboard-controls">
                <h3>Leaderboard Type</h3>
                <div class="category-buttons" id="leaderboard-type-buttons"></div>
                
                <div id="level-group" style="display: none;">
                    <!-- Conteúdo do seletor de level -->
                </div>

                <div id="category-group" style="display: none;">
                    <h3>Categories</h3>
                    <div class="category-buttons" id="category-buttons-container"></div>
                </div>

                <!-- NOVO: Contêiner para subcategorias/variáveis -->
                <div id="variable-group" style="display: none;">
                    <h4 id="variable-title"></h4>
                    <div class="category-buttons" id="variable-buttons-container"></div>
                </div>
            </div>
            <div id="loader">Loading Leaderboard...</div>
            <table>...</table>
            <p id="no-runs-message" style="display: none;">No runs found for this category.</p>
        </div>
    </div>

    <script type="module">
        // Imports e config do Firebase são os mesmos
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        // ... outros imports
        
        const firebaseConfig = { /* ... Sua config ... */ };
        // ... inicialização do app

        // Funções helper (fetchWithCache, formatTime, etc.) são as mesmas

        async function showAdminView() {
            // Adiciona embed=variables para garantir que as variáveis sejam buscadas
            let nextUrl = `${SRC_API_BASE}/series/${SM64_HACKS_SERIES_ID}/games?max=200&embed=levels,categories,variables`;
            // O resto da função de sincronização permanece o mesmo
        }

        async function showLeaderboardView(gameId) {
            showView('leaderboard-view');
            
            const ui = {
                // ... elementos da UI como antes
                variableGroup: document.getElementById('variable-group'),
                variableTitle: document.getElementById('variable-title'),
                variableButtons: document.getElementById('variable-buttons-container'),
            };

            const resetUI = () => {
                // ... reseta todos os elementos da UI como antes
                ui.variableGroup.style.display = 'none';
            };
            resetUI();

            const game = (await get(ref(db, `games_cache/${gameId}`))).val();
            // ... código para buscar e exibir o título do jogo

            const allCategories = (game.categories && game.categories.data) ? game.categories.data : [];
            const allVariables = (game.variables && game.variables.data) ? game.variables.data : [];
            // ... resto do código para obter `fullGameCategories`, `levels`, etc.

            const renderLeaderboard = async (catId, varFilter = '') => {
                ui.loader.style.display = 'block';
                ui.tableBody.innerHTML = '';
                // A URL agora inclui o filtro de variável
                const leaderboard = await fetchWithCache(`leaderboards/${game.id}/category/${catId}${varFilter}`);
                // ... resto da função de renderização da leaderboard
            };

            const renderVariableButtons = (category) => {
                ui.variableGroup.style.display = 'none';
                ui.tableBody.innerHTML = ''; // Limpa a tabela

                const applicableVariables = allVariables.filter(v => v.category === category.id && !v['is-subcategory']);

                if (applicableVariables.length === 0) {
                    renderLeaderboard(category.id); // Sem variáveis, carrega a leaderboard direto
                    return;
                }
                
                // Assumindo uma variável por enquanto (como "Version")
                const mainVariable = applicableVariables[0];
                ui.variableGroup.style.display = 'block';
                ui.variableTitle.textContent = mainVariable.name;
                
                const varButtons = Object.entries(mainVariable.values.values).map(([valueId, valueData]) => 
                    `<button data-var-id="${mainVariable.id}" data-var-value="${valueId}">${valueData.label}</button>`
                ).join('');
                
                ui.variableButtons.innerHTML = varButtons;

                ui.variableButtons.querySelectorAll('button').forEach(btn => {
                    btn.onclick = e => {
                        ui.variableButtons.querySelectorAll('button').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        const varId = e.target.dataset.varId;
                        const varValue = e.target.dataset.varValue;
                        // Monta o filtro para a URL: ?var-variableid=valueid
                        const varFilter = `?var-${varId}=${varValue}`;
                        renderLeaderboard(category.id, varFilter);
                    };
                });
            };

            const renderCategoryButtons = (categories) => {
                ui.categoryGroup.style.display = 'block';
                const catButtons = categories.map(cat => `<button data-cat-id="${cat.id}">${cat.name}</button>`).join('');
                ui.categoryButtonsContainer.innerHTML = catButtons;

                ui.categoryButtonsContainer.querySelectorAll('button').forEach(btn => {
                    btn.onclick = e => {
                        ui.categoryButtonsContainer.querySelectorAll('button').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        const categoryId = e.target.dataset.catId;
                        const selectedCategory = allCategories.find(c => c.id === categoryId);
                        renderVariableButtons(selectedCategory);
                    };
                });
            };

            const showFullGame = () => {
                ui.levelGroup.style.display = 'none';
                ui.variableGroup.style.display = 'none';
                ui.tableBody.innerHTML = '';
                renderCategoryButtons(fullGameCategories);
            };

            // O resto das funções (showPerLevel, inicialização, etc.) permanece o mesmo

        } // Fim de showLeaderboardView

        // O resto do script é o mesmo

    </script>
</body>
</html>
