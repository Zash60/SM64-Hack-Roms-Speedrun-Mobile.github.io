<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SM64 Hacks Speedrun Mobile</title>
    <style>
        :root {
            --bg-color: #18181b;
            --surface-color: #27272a;
            --primary-color: #facc15; /* yellow */
            --text-color: #e4e4e7;
            --text-muted-color: #a1a1aa;
            --border-color: #3f3f46;
        }
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 1rem;
        }
        * { box-sizing: border-box; }

        /* General UI Elements */
        button, select, input {
            background-color: var(--surface-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 0.5rem 0.75rem;
            font-size: 1rem;
        }
        button { cursor: pointer; transition: background-color 0.2s; }
        button:hover { background-color: #3f3f46; }
        button.primary { background-color: var(--primary-color); color: var(--bg-color); font-weight: bold; }
        .hidden { display: none !important; }

        /* Header */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }
        header h1 { font-size: 1.2rem; margin: 0; cursor: pointer; }

        /* Page Containers */
        .page { padding-top: 1rem; }

        /* Home Page */
        #home-page .controls { display: flex; gap: 1rem; margin-bottom: 1rem; }
        #home-page input { flex-grow: 1; }
        .game-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem; }
        .game-card {
            background-color: var(--surface-color);
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            text-decoration: none;
            color: var(--text-color);
            display: flex;
            flex-direction: column;
        }
        .game-card img { width: 100%; height: 120px; object-fit: cover; background-color: #111; }
        .game-card-info { padding: 0.5rem; flex-grow: 1; }
        .game-card-info h3 { font-size: 0.9rem; margin: 0 0 0.25rem 0; }
        .game-card-info p { font-size: 0.8rem; color: var(--text-muted-color); margin: 0; }

        /* Leaderboard Page */
        #leaderboard-page h2 { margin-top: 0; }
        .lb-header { border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; margin-bottom: 1rem; }
        .lb-nav { display: flex; flex-direction: column; gap: 0.75rem; }
        .lb-nav .nav-group { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .lb-nav button, .lb-nav select { flex-grow: 1; }
        .lb-nav button.active { background-color: var(--primary-color); color: var(--bg-color); }

        .leaderboard-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        .leaderboard-table th, .leaderboard-table td {
            padding: 0.75rem 0.5rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        .leaderboard-table th { color: var(--text-muted-color); font-size: 0.8rem; text-transform: uppercase; }
        .leaderboard-table td:nth-child(1) { width: 30px; font-weight: bold; }
        .leaderboard-table td:nth-child(2) { font-weight: bold; }
        .leaderboard-table td:nth-child(3) { text-align: right; }
        .leaderboard-table td:nth-child(4) { text-align: right; color: var(--text-muted-color); }
        .leaderboard-table a { color: var(--primary-color); text-decoration: none; }
        .leaderboard-table a:hover { text-decoration: underline; }

        /* Modal */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.7);
            display: flex; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content {
            background-color: var(--surface-color);
            padding: 1.5rem;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
        }
        .modal-content h3 { margin-top: 0; }
        .modal-content form { display: flex; flex-direction: column; gap: 1rem; }
        .modal-content input { width: 100%; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1.5rem; }

        /* Mod Page */
        #mod-page form { display: flex; flex-direction: column; gap: 1rem; max-width: 400px; margin: auto; }
        .pending-run { background-color: var(--surface-color); padding: 1rem; border-radius: 6px; margin-bottom: 1rem; }
        .pending-run p { margin: 0 0 0.5rem 0; }
        .pending-run strong { color: var(--primary-color); }
        .pending-run-actions { display: flex; gap: 0.5rem; margin-top: 1rem; }

        /* Loader */
        .loader {
            text-align: center;
            padding: 2rem;
            font-size: 1.2rem;
            color: var(--text-muted-color);
        }
    </style>
</head>
<body>

    <header>
        <h1 id="home-button">SM64 Hacks Mobile</h1>
        <div>
            <button id="mod-button">Mod</button>
        </div>
    </header>

    <main>
        <!-- Home Page -->
        <div id="home-page" class="page">
            <div class="controls">
                <input type="search" id="search-bar" placeholder="Search for a hack...">
                <select id="sort-select">
                    <option value="newest">Newest Released</option>
                    <option value="oldest">Oldest Released</option>
                    <option value="alpha">Alphabetical</option>
                </select>
            </div>
            <div id="game-list-container" class="game-grid"></div>
            <div id="home-loader" class="loader">Loading hacks...</div>
        </div>

        <!-- Leaderboard Page -->
        <div id="leaderboard-page" class="page hidden">
            <div class="lb-header">
                <h2 id="lb-game-title"></h2>
                <div id="lb-nav-container" class="lb-nav"></div>
                 <div id="lb-submit-container" style="margin-top: 1rem;">
                    <button id="submit-run-btn" class="primary">Submit Run</button>
                </div>
            </div>
            <div id="leaderboard-loader" class="loader">Loading leaderboard...</div>
            <table id="leaderboard-table" class="leaderboard-table">
                <thead><tr><th>#</th><th>Player</th><th>Time</th><th>Date</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- Mod Page -->
        <div id="mod-page" class="page hidden">
            <div id="mod-login-view">
                <h3>Moderator Login</h3>
                <form id="login-form">
                    <input type="email" id="login-email" placeholder="Email" required>
                    <input type="password" id="login-password" placeholder="Password" required>
                    <button type="submit" class="primary">Login</button>
                    <p id="login-error" style="color: #ef4444;"></p>
                </form>
            </div>
            <div id="mod-panel-view" class="hidden">
                <h3>Pending Runs <button id="logout-btn" style="float: right;">Logout</button></h3>
                <div id="pending-runs-container"></div>
                <div id="mod-loader" class="loader">Loading pending runs...</div>
            </div>
        </div>
    </main>

    <!-- Submit Run Modal -->
    <div id="submit-modal" class="modal hidden">
        <div class="modal-content">
            <h3>Submit Run</h3>
            <p id="submit-modal-info"></p>
            <form id="submit-form">
                <input type="text" id="submit-player" placeholder="Player Name" required>
                <input type="text" id="submit-time" placeholder="Time (e.g., 1h 23m 45s 678ms)" required>
                <input type="url" id="submit-video" placeholder="Video URL (e.g., YouTube, Twitch)" required>
                <input type="date" id="submit-date" required>
                <div class="modal-actions">
                    <button type="button" id="cancel-submit-btn">Cancel</button>
                    <button type="submit" class="primary">Submit</button>
                </div>
            </form>
        </div>
    </div>


    <script type="module">
        // Import Firebase functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getDatabase, ref, set, get, onValue, remove, push } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAsVYnWAq5aFOz9dIxHpGVWK8Mk64f01GU", // Replace with your actual key if needed
            authDomain: "sm64-hack-roms-speedrun-mobile.firebaseapp.com",
            databaseURL: "https://sm64-hack-roms-speedrun-mobile-default-rtdb.firebaseio.com",
            projectId: "sm64-hack-roms-speedrun-mobile",
            storageBucket: "sm64-hack-roms-speedrun-mobile.firebasestorage.app",
            messagingSenderId: "499101981060",
            appId: "1:499101981060:web:209dfe3f20866ef4f865d1"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const auth = getAuth(app);

        // --- GLOBAL STATE & CONSTANTS ---
        const SRC_API_BASE = "https://www.speedrun.com/api/v1";
        const SM64_HACKS_SERIES_ID = "4p02y7g9";
        let allGames = [];
        let currentLeaderboardState = {};

        // --- UI ELEMENTS ---
        const pages = {
            home: document.getElementById('home-page'),
            leaderboard: document.getElementById('leaderboard-page'),
            mod: document.getElementById('mod-page')
        };
        const searchBar = document.getElementById('search-bar');
        const sortSelect = document.getElementById('sort-select');
        const gameListContainer = document.getElementById('game-list-container');
        const homeLoader = document.getElementById('home-loader');

        // --- HELPERS ---
        const showPage = (pageId) => {
            Object.values(pages).forEach(page => page.classList.add('hidden'));
            if (pages[pageId]) pages[pageId].classList.remove('hidden');
        };

        const timeAgo = (dateStr) => {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            const seconds = Math.floor((new Date() - date) / 1000);
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + " years ago";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + " months ago";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + " days ago";
            return "Today";
        };

        // --- CACHING ---
        const cache = {
            get: (key) => {
                const item = sessionStorage.getItem(key);
                return item ? JSON.parse(item) : null;
            },
            set: (key, value) => {
                sessionStorage.setItem(key, JSON.stringify(value));
            }
        };

        // --- SPEEDRUN.COM API FETCHER ---
        async function fetchSRCApi(endpoint) {
            const url = `${SRC_API_BASE}${endpoint}`;
            const cachedData = cache.get(url);
            if (cachedData) return cachedData;

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
                const data = await response.json();
                cache.set(url, data);
                return data;
            } catch (error) {
                console.error(`Failed to fetch from ${url}`, error);
                return null;
            }
        }

        // --- ROUTING ---
        function router() {
            const hash = window.location.hash.slice(1);
            if (hash.startsWith('game/')) {
                const gameId = hash.split('/')[1];
                loadLeaderboardPage(gameId);
            } else if (hash === 'mod') {
                showPage('mod');
            } else {
                showPage('home');
                if (allGames.length === 0) loadHomePage();
            }
        }

        // --- HOME PAGE LOGIC ---
        async function loadHomePage() {
            homeLoader.classList.remove('hidden');
            gameListContainer.innerHTML = '';

            let gamesData = [];
            let offset = 0;
            let hasMore = true;
            while(hasMore) {
                // *** FIX #1: Changed 'orderby=released' to 'orderby=release-date' ***
                const data = await fetchSRCApi(`/series/${SM64_HACKS_SERIES_ID}/games?offset=${offset}&max=200&orderby=release-date&direction=desc`);
                if (data && data.data.length > 0) {
                    gamesData.push(...data.data);
                    offset += 200;
                    hasMore = data.pagination.links.some(link => link.rel === 'next');
                } else {
                    hasMore = false;
                }
            }
            
            allGames = gamesData;
            homeLoader.classList.add('hidden');
            renderGames();
        }

        function renderGames() {
            const searchTerm = searchBar.value.toLowerCase();
            const sortMethod = sortSelect.value;

            let filteredGames = allGames.filter(game =>
                game.names.international.toLowerCase().includes(searchTerm)
            );

            filteredGames.sort((a, b) => {
                // *** FIX #2: Changed '.released' to "['release-date']" for correct sorting ***
                if (sortMethod === 'alpha') return a.names.international.localeCompare(b.names.international);
                if (sortMethod === 'oldest') return new Date(a['release-date']) - new Date(b['release-date']);
                return new Date(b['release-date']) - new Date(a['release-date']); // newest (default)
            });

            gameListContainer.innerHTML = filteredGames.map(game => `
                <a href="#game/${game.id}" class="game-card">
                    <img src="${game.assets['cover-medium'].uri}" alt="${game.names.international} cover">
                    <div class="game-card-info">
                        <h3>${game.names.international}</h3>
                        <!-- *** FIX #3: Changed 'game.release_date' to "game['release-date']" for correct time ago display *** -->
                        <p>${game.released} (${timeAgo(game['release-date'])})</p>
                    </div>
                </a>
            `).join('');
        }

        // --- LEADERBOARD PAGE LOGIC ---
        async function loadLeaderboardPage(gameId) {
            showPage('leaderboard');
            const lbTableBody = document.querySelector('#leaderboard-table tbody');
            const lbNavContainer = document.getElementById('lb-nav-container');
            const lbLoader = document.getElementById('leaderboard-loader');
            
            lbTableBody.innerHTML = '';
            lbNavContainer.innerHTML = '';
            lbLoader.classList.remove('hidden');

            const [gameData, categoriesData] = await Promise.all([
                fetchSRCApi(`/games/${gameId}`),
                fetchSRCApi(`/games/${gameId}/categories`)
            ]);
            
            if (!gameData || !categoriesData) {
                document.getElementById('lb-game-title').innerText = 'Error loading game';
                lbLoader.classList.add('hidden');
                return;
            }

            document.getElementById('lb-game-title').innerText = gameData.data.names.international;
            
            const categories = categoriesData.data;
            const fullGameCategories = categories.filter(c => c.type === 'per-game');
            const levelCategories = categories.filter(c => c.type === 'per-level');
            const levels = gameData.data.levels.data;

            currentLeaderboardState = {
                gameId: gameId,
                gameName: gameData.data.names.international,
                isLevel: false,
                levelId: null,
                categoryId: null,
                subcategories: {}
            };
            
            buildLeaderboardNav(fullGameCategories, levelCategories, levels);
            lbLoader.classList.add('hidden');
            
            const firstNavButton = lbNavContainer.querySelector('button');
            if(firstNavButton) firstNavButton.click();
        }

        function buildLeaderboardNav(fullGameCats, levelCats, levels) {
            const container = document.getElementById('lb-nav-container');
            container.innerHTML = '';

            const typeSelector = document.createElement('div');
            typeSelector.className = 'nav-group';
            
            if (fullGameCats.length > 0) {
                const fullGameBtn = document.createElement('button');
                fullGameBtn.innerText = 'Full Game';
                fullGameBtn.onclick = () => {
                    currentLeaderboardState.isLevel = false;
                    renderCategorySelectors(fullGameCats);
                    setActiveButton(fullGameBtn, typeSelector);
                };
                typeSelector.appendChild(fullGameBtn);
            }

            if (levelCats.length > 0 && levels.length > 0) {
                const levelsBtn = document.createElement('button');
                levelsBtn.innerText = 'Levels';
                levelsBtn.onclick = () => {
                    currentLeaderboardState.isLevel = true;
                    renderLevelSelector(levels, levelCats);
                    setActiveButton(levelsBtn, typeSelector);
                };
                typeSelector.appendChild(levelsBtn);
            }
            container.appendChild(typeSelector);
            
            container.appendChild(document.createElement('div')).id = 'lb-level-selector-container';
            container.appendChild(document.createElement('div')).id = 'lb-category-selector-container';
            container.appendChild(document.createElement('div')).id = 'lb-subcategory-selector-container';
            container.appendChild(document.createElement('div')).id = 'lb-star-selector-container';
        }

        function setActiveButton(activeBtn, group) {
            group.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
            activeBtn.classList.add('active');
        }

        function renderCategorySelectors(categories) {
            document.getElementById('lb-level-selector-container').innerHTML = '';
            document.getElementById('lb-star-selector-container').innerHTML = '';
            const container = document.getElementById('lb-category-selector-container');
            container.innerHTML = '';
            const group = document.createElement('div');
            group.className = 'nav-group';

            categories.forEach(cat => {
                const btn = document.createElement('button');
                btn.innerText = cat.name;
                btn.onclick = async () => {
                    currentLeaderboardState.categoryId = cat.id;
                    currentLeaderboardState.categoryName = cat.name;
                    currentLeaderboardState.subcategories = {};
                    setActiveButton(btn, group);
                    await renderSubcategorySelectors(cat.variables.data);
                    
                    if (currentLeaderboardState.isLevel && cat.name.toLowerCase().includes('single star')) {
                        renderStarSelector();
                    } else {
                        document.getElementById('lb-star-selector-container').innerHTML = '';
                        fetchAndDisplayLeaderboard();
                    }
                };
                group.appendChild(btn);
            });
            container.appendChild(group);
            if(group.firstChild) group.firstChild.click();
        }

        function renderLevelSelector(levels, levelCats) {
            document.getElementById('lb-category-selector-container').innerHTML = '';
            document.getElementById('lb-subcategory-selector-container').innerHTML = '';
            document.getElementById('lb-star-selector-container').innerHTML = '';
            const container = document.getElementById('lb-level-selector-container');
            const select = document.createElement('select');
            select.innerHTML = `<option>-- Select a Level --</option>` + levels.map(lvl => `<option value="${lvl.id}">${lvl.name}</option>`).join('');
            select.onchange = () => {
                currentLeaderboardState.levelId = select.value;
                currentLeaderboardState.levelName = select.options[select.selectedIndex].text;
                if(select.value) {
                    renderCategorySelectors(levelCats);
                }
            };
            container.innerHTML = '';
            container.appendChild(select);
        }

        async function renderSubcategorySelectors(variables) {
            const container = document.getElementById('lb-subcategory-selector-container');
            container.innerHTML = '';
            if (!variables || variables.length === 0) {
                fetchAndDisplayLeaderboard();
                return;
            }

            for (const variable of variables) {
                if(variable['is-subcategory']) {
                    const group = document.createElement('div');
                    group.className = 'nav-group';
                    const label = document.createElement('span');
                    label.innerText = variable.name + ':';
                    group.appendChild(label);
                    
                    const values = Object.entries(variable.values.values);
                    values.forEach(([valueId, valueData]) => {
                        const btn = document.createElement('button');
                        btn.innerText = valueData.label;
                        btn.onclick = () => {
                            currentLeaderboardState.subcategories[variable.id] = { id: valueId, name: valueData.label };
                            setActiveButton(btn, group);
                            fetchAndDisplayLeaderboard();
                        };
                        group.appendChild(btn);
                    });
                    container.appendChild(group);
                    if(group.children[1]) group.children[1].click();
                }
            }
             if(container.innerHTML === '') fetchAndDisplayLeaderboard();
        }
        
        async function renderStarSelector() {
            const container = document.getElementById('lb-star-selector-container');
            container.innerHTML = '';
            const select = document.createElement('select');
            select.innerHTML = '<option>-- Loading Stars --</option>';
            container.appendChild(select);

            const lbData = await fetchSRCApi(`/leaderboards/${currentLeaderboardState.gameId}/level/${currentLeaderboardState.levelId}/${currentLeaderboardState.categoryId}`);
            if (lbData && lbData.data.runs.length > 0) {
                const firstRunVariables = lbData.data.runs[0].run.values;
                const starVariableId = Object.keys(firstRunVariables)[0];
                
                const variableInfo = lbData.data.variables.data.find(v => v.id === starVariableId);
                if (variableInfo) {
                    currentLeaderboardState.starVariableId = starVariableId;
                    const stars = Object.entries(variableInfo.values.values);
                    select.innerHTML = '<option>-- Select a Star --</option>' + stars.map(([id, data]) => `<option value="${id}">${data.label}</option>`).join('');
                    
                    select.onchange = () => {
                        currentLeaderboardState.starId = select.value;
                        currentLeaderboardState.starName = select.options[select.selectedIndex].text;
                        fetchAndDisplayLeaderboard();
                    }
                } else {
                     select.innerHTML = '<option>-- No stars found --</option>';
                }
            } else {
                select.innerHTML = '<option>-- No runs found to determine stars --</option>';
            }
        }

        function getFirebaseLeaderboardPath() {
            let path = `leaderboards/${currentLeaderboardState.gameId}/`;
            if (currentLeaderboardState.isLevel) {
                path += `level_${currentLeaderboardState.levelId}_${currentLeaderboardState.categoryId}`;
                if (currentLeaderboardState.starId) {
                    path += `_star_${currentLeaderboardState.starId}`;
                }
            } else {
                path += `game_${currentLeaderboardState.categoryId}`;
                const subcatIds = Object.keys(currentLeaderboardState.subcategories).sort();
                subcatIds.forEach(varId => {
                    path += `_${varId}_${currentLeaderboardState.subcategories[varId].id}`;
                });
            }
            return path;
        }

        function fetchAndDisplayLeaderboard() {
            const path = getFirebaseLeaderboardPath();
            if(!path) return;

            const lbTableBody = document.querySelector('#leaderboard-table tbody');
            const lbLoader = document.getElementById('leaderboard-loader');
            lbLoader.classList.remove('hidden');
            lbTableBody.innerHTML = '';

            const runsRef = ref(database, path);
            onValue(runsRef, (snapshot) => {
                const data = snapshot.val();
                lbLoader.classList.add('hidden');
                if (data) {
                    const runs = Object.values(data);
                    runs.sort((a,b) => parseTimeToMs(a.time) - parseTimeToMs(b.time));
                    
                    lbTableBody.innerHTML = runs.map((run, index) => `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${run.player}</td>
                            <td><a href="${run.video}" target="_blank">${run.time}</a></td>
                            <td>${timeAgo(run.date)}</td>
                        </tr>
                    `).join('');
                } else {
                    lbTableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">No runs found. Be the first!</td></tr>';
                }
            }, { onlyOnce: true });
        }
        
        function parseTimeToMs(timeStr) {
            let ms = 0;
            const parts = timeStr.toLowerCase().split(' ');
            parts.forEach(part => {
                if (part.includes('h')) ms += parseInt(part) * 3600000;
                else if (part.includes('m') && !part.includes('ms')) ms += parseInt(part) * 60000;
                else if (part.includes('s') && !part.includes('ms')) ms += parseInt(part) * 1000;
                else if (part.includes('ms')) ms += parseInt(part);
            });
            return ms;
        }


        // --- SUBMIT RUN MODAL ---
        const submitModal = document.getElementById('submit-modal');
        const submitForm = document.getElementById('submit-form');
        
        document.getElementById('submit-run-btn').addEventListener('click', () => {
            let info = `Submitting for: <strong>${currentLeaderboardState.gameName}</strong> - `;
            if (currentLeaderboardState.isLevel) {
                info += `${currentLeaderboardState.levelName} - ${currentLeaderboardState.categoryName}`;
                if (currentLeaderboardState.starName) {
                    info += ` (${currentLeaderboardState.starName})`;
                }
            } else {
                 info += `${currentLeaderboardState.categoryName}`;
                 Object.values(currentLeaderboardState.subcategories).forEach(sub => {
                     info += ` (${sub.name})`;
                 });
            }
            document.getElementById('submit-modal-info').innerHTML = info;
            document.getElementById('submit-date').valueAsDate = new Date();
            submitModal.classList.remove('hidden');
        });

        document.getElementById('cancel-submit-btn').addEventListener('click', () => {
            submitModal.classList.add('hidden');
            submitForm.reset();
        });

        submitForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const runData = {
                player: document.getElementById('submit-player').value,
                time: document.getElementById('submit-time').value,
                video: document.getElementById('submit-video').value,
                date: document.getElementById('submit-date').value,
                submittedAt: new Date().toISOString(),
                leaderboardPath: getFirebaseLeaderboardPath(),
                leaderboardInfo: document.getElementById('submit-modal-info').innerHTML
            };

            const pendingRunsRef = ref(database, 'pending_runs');
            push(pendingRunsRef, runData)
                .then(() => {
                    alert('Run submitted for moderation!');
                    submitModal.classList.add('hidden');
                    submitForm.reset();
                })
                .catch(error => {
                    alert('Error submitting run: ' + error.message);
                });
        });

        // --- MODERATION LOGIC ---
        const modLoginView = document.getElementById('mod-login-view');
        const modPanelView = document.getElementById('mod-panel-view');
        
        onAuthStateChanged(auth, user => {
            if (user) {
                modLoginView.classList.add('hidden');
                modPanelView.classList.remove('hidden');
                loadPendingRuns();
            } else {
                modLoginView.classList.remove('hidden');
                modPanelView.add('hidden');
            }
        });
        
        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const loginError = document.getElementById('login-error');
            loginError.textContent = '';
            
            signInWithEmailAndPassword(auth, email, password)
                .catch(error => {
                    loginError.textContent = error.message;
                });
        });
        
        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
        
        function loadPendingRuns() {
            const container = document.getElementById('pending-runs-container');
            const loader = document.getElementById('mod-loader');
            loader.classList.remove('hidden');
            
            const pendingRef = ref(database, 'pending_runs');
            onValue(pendingRef, (snapshot) => {
                container.innerHTML = '';
                loader.classList.add('hidden');
                const data = snapshot.val();
                if (data) {
                    Object.entries(data).forEach(([key, run]) => {
                        const div = document.createElement('div');
                        div.className = 'pending-run';
                        div.innerHTML = `
                            <p><strong>Run Info:</strong> ${run.leaderboardInfo}</p>
                            <p><strong>Player:</strong> ${run.player}</p>
                            <p><strong>Time:</strong> ${run.time}</p>
                            <p><strong>Video:</strong> <a href="${run.video}" target="_blank">Watch</a></p>
                            <p><strong>Date:</strong> ${run.date}</p>
                            <div class="pending-run-actions">
                                <button class="approve-btn primary" data-key="${key}">Approve</button>
                                <button class="reject-btn" data-key="${key}">Reject</button>
                            </div>
                        `;
                        container.appendChild(div);
                    });
                } else {
                    container.innerHTML = '<p>No pending runs.</p>';
                }
            });
        }
        
        document.getElementById('pending-runs-container').addEventListener('click', (e) => {
            const key = e.target.dataset.key;
            if (!key) return;
            
            if (e.target.classList.contains('approve-btn')) {
                approveRun(key);
            } else if (e.target.classList.contains('reject-btn')) {
                rejectRun(key);
            }
        });
        
        async function approveRun(key) {
            const pendingRunRef = ref(database, `pending_runs/${key}`);
            const snapshot = await get(pendingRunRef);
            if (!snapshot.exists()) {
                alert('Run no longer exists.');
                return;
            }
            
            const runData = snapshot.val();
            const leaderboardPath = runData.leaderboardPath;
            
            delete runData.leaderboardPath;
            delete runData.leaderboardInfo;
            delete runData.submittedAt;
            
            const leaderboardRef = ref(database, leaderboardPath);
            const newRunRef = push(leaderboardRef);
            
            await set(newRunRef, runData);
            await remove(pendingRunRef);
            
            alert('Run approved!');
        }

        async function rejectRun(key) {
             if (confirm('Are you sure you want to reject this run?')) {
                const pendingRunRef = ref(database, `pending_runs/${key}`);
                await remove(pendingRunRef);
                alert('Run rejected.');
            }
        }


        // --- INITIALIZATION ---
        document.getElementById('home-button').addEventListener('click', () => window.location.hash = '');
        document.getElementById('mod-button').addEventListener('click', () => window.location.hash = 'mod');
        searchBar.addEventListener('input', renderGames);
        sortSelect.addEventListener('change', renderGames);
        window.addEventListener('hashchange', router);
        
        router();

    </script>
</body>
</html>
