<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SM64 Hacks Speedrun</title>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --card-color: #2a2a2a;
            --text-color: #f0f0f0;
            --primary-color: #e53d00;
            --border-color: #444;
            --accent-color: #ffd700;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
        }

        .hidden {
            display: none !important;
        }

        /* --- Estrutura Principal --- */
        #app-container {
            max-width: 800px;
            margin: auto;
            padding: 10px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: var(--card-color);
            border-bottom: 2px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        header h1 {
            margin: 0;
            font-size: 1.5em;
            color: var(--primary-color);
        }

        nav button {
            background: none;
            border: 1px solid var(--text-color);
            color: var(--text-color);
            padding: 8px 12px;
            margin-left: 10px;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.2s;
        }

        nav button.active {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        /* --- Views --- */
        .view {
            padding-top: 20px;
        }

        /* --- Loader --- */
        #loader {
            text-align: center;
            font-size: 1.2em;
            padding: 40px;
        }

        /* --- Home View (Lista de Jogos) --- */
        #games-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
        }

        .game-card {
            background-color: var(--card-color);
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s;
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        .game-card:hover {
            transform: scale(1.05);
            border-color: var(--primary-color);
        }

        .game-card-image-container {
            width: 100%;
            height: 120px;
            background-color: #444;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5em;
            color: #777;
        }

        .game-card-image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .game-card-title {
            padding: 10px;
            font-weight: bold;
            font-size: 0.9em;
            text-align: center;
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* --- Game & Leaderboard Views --- */
        .breadcrumb {
            margin-bottom: 20px;
            font-size: 0.9em;
            color: #aaa;
        }
        .breadcrumb a {
            color: var(--text-color);
            cursor: pointer;
            text-decoration: none;
        }
        .breadcrumb a:hover { text-decoration: underline; }

        .list-container h2 {
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 5px;
            margin-top: 25px;
        }
        .list-container:first-child h2 { margin-top: 0; }

        .list-item {
            background-color: var(--card-color);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            cursor: pointer;
            border-left: 3px solid transparent;
            transition: all 0.2s;
        }

        .list-item:hover {
            border-left: 3px solid var(--primary-color);
            background-color: #333;
        }

        #leaderboard-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        #leaderboard-table th, #leaderboard-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        #leaderboard-table th {
            background-color: #333;
        }

        #leaderboard-table tr:nth-child(even) {
            background-color: var(--card-color);
        }

        .rank-1 { color: gold; font-weight: bold; }
        .rank-2 { color: silver; }
        .rank-3 { color: #cd7f32; }

        /* --- Mod View & Forms --- */
        .form-container {
            background-color: var(--card-color);
            padding: 20px;
            border-radius: 8px;
        }
        .form-container h2 { margin-top: 0; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; }
        .form-group input {
            width: 100%;
            padding: 10px;
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            border-radius: 5px;
            box-sizing: border-box;
        }

        button.primary-btn {
            background-color: var(--primary-color);
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
            font-size: 1em;
            font-weight: bold;
        }
        button.primary-btn:hover { background-color: #c43100; }
        #logout-btn { background-color: #888; margin-top: 15px; }
        #logout-btn:hover { background-color: #666; }

        #submit-run-btn {
            margin-top: 20px;
            padding: 12px;
        }

        #error-message {
            color: #ff4d4d;
            margin-top: 10px;
        }
    </style>
</head>
<body>

    <div id="app-container">
        <header>
            <h1>SM64 Hacks Mobile</h1>
            <nav>
                <button id="home-tab" class="active">Home</button>
                <button id="mod-tab">Mod</button>
            </nav>
        </header>

        <main>
            <div id="loader" class="">
                <p>Carregando jogos...</p>
            </div>
            
            <div id="home-view" class="view">
                <div id="games-grid"></div>
            </div>

            <div id="game-view" class="view hidden">
                <div class="breadcrumb" id="game-breadcrumb"></div>
                <div id="game-details"></div>
            </div>

            <div id="leaderboard-view" class="view hidden">
                <div class="breadcrumb" id="leaderboard-breadcrumb"></div>
                <div class="list-container">
                    <h2 id="leaderboard-title">Leaderboard</h2>
                    <table id="leaderboard-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Tempo</th>
                                <th>Data</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboard-body"></tbody>
                    </table>
                </div>
                <button id="submit-run-btn" class="primary-btn hidden">Submit Run</button>
                <div id="submit-run-form-container" class="form-container hidden" style="margin-top: 20px;">
                    <h2>Enviar Tempo</h2>
                    <form id="submit-run-form">
                        <div class="form-group">
                            <label for="run-time">Tempo (ex: 1m 23s 456ms)</label>
                            <input type="text" id="run-time" required>
                        </div>
                        <button type="submit" class="primary-btn">Enviar</button>
                    </form>
                </div>
            </div>

            <div id="mod-view" class="view hidden">
                <div id="login-container" class="form-container">
                    <h2>Login de Moderador</h2>
                    <form id="login-form">
                        <div class="form-group">
                            <label for="email">Email</label>
                            <input type="email" id="email" required>
                        </div>
                        <div class="form-group">
                            <label for="password">Senha</label>
                            <input type="password" id="password" required>
                        </div>
                        <button type="submit" class="primary-btn">Entrar</button>
                        <p id="login-error-message" class="error-message"></p>
                    </form>
                </div>

                <div id="mod-panel" class="hidden">
                    <h2>Painel do Moderador</h2>
                    <p>Você está logado. Agora você pode enviar tempos nos leaderboards.</p>
                    <button id="logout-btn" class="primary-btn">Sair</button>
                </div>
            </div>
        </main>
    </div>

    <!-- Script com a lógica -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getDatabase, ref, onValue, push, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAsVYnWAq5aFOz9dIxHpGVWK8Mk64f01GU",
            authDomain: "sm64-hack-roms-speedrun-mobile.firebaseapp.com",
            databaseURL: "https://sm64-hack-roms-speedrun-mobile-default-rtdb.firebaseio.com",
            projectId: "sm64-hack-roms-speedrun-mobile",
            storageBucket: "sm64-hack-roms-speedrun-mobile.firebasestorage.app",
            messagingSenderId: "499101981060",
            appId: "1:499101981060:web:209dfe3f20866ef4f865d1"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        const speedrunApiBase = "https://www.speedrun.com/api/v1";
        const sm64HacksSeriesId = "sm64romhacks";

        const loader = document.getElementById('loader');
        const views = document.querySelectorAll('.view');
        const homeTab = document.getElementById('home-tab');
        const modTab = document.getElementById('mod-tab');
        
        let currentGame = null;
        let currentLeaderboardInfo = null;
        let allGamesCache = []; // Cache para não buscar os jogos toda vez

        // --- Funções de Utilidade ---
        function showLoader(message = "Carregando...") { 
            loader.querySelector('p').textContent = message;
            loader.classList.remove('hidden'); 
        }
        function hideLoader() { loader.classList.add('hidden'); }

        // **NOVO**: Função para limpar o texto Markdown
        function parseMarkdown(text) {
            if (!text) return '';
            // Converte "[texto](url)" para apenas "texto"
            return text.replace(/\[([^\]]+)\]\([^)]+\)/g, '$1');
        }

        function switchView(viewId) {
            views.forEach(view => view.classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
            hideLoader();
            window.scrollTo(0, 0); // Rola para o topo ao mudar de tela
        }

        function setActiveTab(tab) {
            [homeTab, modTab].forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
        }

        // --- Funções da API Speedrun.com ---
        async function apiFetch(url) { // Agora aceita a URL completa
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
                return await response.json();
            } catch (error) {
                console.error("Erro ao buscar dados da API:", error);
                alert("Não foi possível carregar os dados. Tente novamente mais tarde.");
                return null;
            }
        }
        
        // **ATUALIZADO**: Função para buscar TODOS os jogos com paginação
        async function fetchAllGames() {
            if (allGamesCache.length > 0) {
                return allGamesCache;
            }

            showLoader('Carregando todos os 223+ hacks...');
            let allGames = [];
            let nextUrl = `${speedrunApiBase}/series/${sm64HacksSeriesId}/games?orderby=released&direction=asc&max=200`; // max=200 é o máximo por página

            while (nextUrl) {
                const response = await apiFetch(nextUrl);
                if (response && response.data) {
                    allGames.push(...response.data);
                    const nextLink = response.pagination.links.find(link => link.rel === 'next');
                    nextUrl = nextLink ? nextLink.uri : null;
                } else {
                    nextUrl = null; // Para o loop em caso de erro
                }
            }
            allGamesCache = allGames; // Salva no cache
            return allGames;
        }

        async function displayGames() {
            const games = await fetchAllGames();
            if (!games) { hideLoader(); return; }

            const gamesGrid = document.getElementById('games-grid');
            gamesGrid.innerHTML = '';
            games.forEach(game => {
                const card = document.createElement('div');
                card.className = 'game-card';
                card.dataset.gameId = game.id;
                
                let imageUrl = '';
                if (game.assets['cover-medium']?.uri) {
                    imageUrl = game.assets['cover-medium'].uri;
                } else if (game.assets['cover-small']?.uri) {
                    imageUrl = game.assets['cover-small'].uri;
                }

                const imageHtml = imageUrl 
                    ? `<img src="${imageUrl}" alt="${game.names.international}">`
                    : `?`;

                card.innerHTML = `
                    <div class="game-card-image-container">${imageHtml}</div>
                    <div class="game-card-title">${game.names.international}</div>
                `;
                card.addEventListener('click', () => fetchGameDetails(game.id, game.names.international));
                gamesGrid.appendChild(card);
            });
            switchView('home-view');
        }

        async function fetchGameDetails(gameId, gameName) {
            showLoader(`Carregando ${gameName}...`);
            currentGame = { id: gameId, name: gameName };
            const [categoriesData, levelsData] = await Promise.all([
                apiFetch(`${speedrunApiBase}/games/${gameId}/categories`),
                apiFetch(`${speedrunApiBase}/games/${gameId}/levels`)
            ]);

            const categories = categoriesData?.data || [];
            const levels = levelsData?.data || [];
            
            const gameDetailsContainer = document.getElementById('game-details');
            gameDetailsContainer.innerHTML = '';

            document.getElementById('game-breadcrumb').innerHTML = `<a id="breadcrumb-home">Home</a> > ${gameName}`;
            document.getElementById('breadcrumb-home').onclick = () => switchView('home-view');

            const fullGameCategories = categories.filter(cat => cat.type === 'per-game');
            if (fullGameCategories.length > 0) {
                const container = document.createElement('div');
                container.className = 'list-container';
                container.innerHTML = `<h2>Full Game</h2>`;
                fullGameCategories.forEach(cat => {
                    const item = document.createElement('div');
                    item.className = 'list-item';
                    item.textContent = parseMarkdown(cat.name); // Limpa o nome
                    item.onclick = () => showLeaderboard(gameId, cat.id, null, cat.name);
                    container.appendChild(item);
                });
                gameDetailsContainer.appendChild(container);
            }
            
            const perLevelCategories = categories.filter(cat => cat.type === 'per-level');
            if (perLevelCategories.length > 0 && levels.length > 0) {
                 for (const level of levels) {
                    const container = document.createElement('div');
                    container.className = 'list-container';
                    container.innerHTML = `<h2>${parseMarkdown(level.name)}</h2>`; // Limpa o nome do nível

                    const singleStarCat = perLevelCategories.find(c => c.name.toLowerCase().includes('single star'));
                    const stageRTACat = perLevelCategories.find(c => c.name.toLowerCase().includes('stage rta'));

                    if(singleStarCat) {
                        const variablesData = await apiFetch(`${speedrunApiBase}/levels/${level.id}/variables`);
                        const variables = variablesData?.data || [];
                        if(variables.length > 0 && variables[0].is_subcategory) {
                            const stars = variables[0].values.values;
                            for (const starKey in stars) {
                                const star = stars[starKey];
                                const item = document.createElement('div');
                                item.className = 'list-item';
                                item.textContent = parseMarkdown(star.label); // Limpa o nome da estrela
                                item.onclick = () => showLeaderboard(gameId, singleStarCat.id, level.id, star.label, starKey);
                                container.appendChild(item);
                            }
                        }
                    } 
                    if (stageRTACat) {
                        const item = document.createElement('div');
                        item.className = 'list-item';
                        item.textContent = "Stage RTA";
                        item.onclick = () => showLeaderboard(gameId, stageRTACat.id, level.id, "Stage RTA");
                        container.appendChild(item);
                    }
                    if (container.childElementCount > 1) { // Só adiciona se tiver itens
                        gameDetailsContainer.appendChild(container);
                    }
                }
            }
            switchView('game-view');
        }

        // --- Funções do Firebase (Leaderboard) ---
        let currentLeaderboardListener = null;

        function showLeaderboard(gameId, categoryId, levelId, rawTitle, subcategoryId = null) {
            showLoader();
            const cleanTitle = parseMarkdown(rawTitle); // Limpa o título
            const leaderboardTitle = document.getElementById('leaderboard-title');
            leaderboardTitle.textContent = cleanTitle;

            document.getElementById('leaderboard-breadcrumb').innerHTML = `
                <a id="breadcrumb-home-l">Home</a> > 
                <a id="breadcrumb-game-l">${currentGame.name}</a> > 
                ${cleanTitle}
            `;
            document.getElementById('breadcrumb-home-l').onclick = () => displayGames();
            document.getElementById('breadcrumb-game-l').onclick = () => fetchGameDetails(currentGame.id, currentGame.name);

            let path = `leaderboards/${gameId}/${categoryId}`;
            if (levelId) path += `/${levelId}`;
            if (subcategoryId) path += `/${subcategoryId}`;
            
            currentLeaderboardInfo = { path: path };

            const leaderboardRef = ref(db, path);
            const leaderboardBody = document.getElementById('leaderboard-body');
            
            if (currentLeaderboardListener) currentLeaderboardListener();

            currentLeaderboardListener = onValue(leaderboardRef, (snapshot) => {
                leaderboardBody.innerHTML = '';
                const data = snapshot.val();
                if (data) {
                    const runs = Object.values(data).sort((a, b) => a.time.localeCompare(b.time));
                    runs.forEach((run, index) => {
                        const rank = index + 1;
                        const row = document.createElement('tr');
                        
                        let rankClass = '';
                        if (rank === 1) rankClass = 'rank-1';
                        if (rank === 2) rankClass = 'rank-2';
                        if (rank === 3) rankClass = 'rank-3';

                        row.innerHTML = `
                            <td class="${rankClass}">${rank}</td>
                            <td>${run.time}</td>
                            <td>${new Date(run.date).toLocaleDateString()}</td>
                        `;
                        leaderboardBody.appendChild(row);
                    });
                } else {
                    leaderboardBody.innerHTML = '<tr><td colspan="3">Nenhum tempo enviado ainda.</td></tr>';
                }
                switchView('leaderboard-view');
            });
        }
        
        async function submitRun(time) {
            if (!currentLeaderboardInfo || !currentLeaderboardInfo.path) {
                alert("Erro: Nenhuma leaderboard selecionada.");
                return;
            }
            try {
                const leaderboardRef = ref(db, currentLeaderboardInfo.path);
                await push(leaderboardRef, {
                    time: time,
                    date: serverTimestamp()
                });
                alert("Tempo enviado com sucesso!");
                document.getElementById('submit-run-form').reset();
                document.getElementById('submit-run-form-container').classList.add('hidden');
            } catch (error) {
                console.error("Erro ao enviar o tempo:", error);
                alert("Falha ao enviar o tempo.");
            }
        }

        // --- Funções de Autenticação do Firebase ---
        onAuthStateChanged(auth, user => {
            const modPanel = document.getElementById('mod-panel');
            const loginContainer = document.getElementById('login-container');
            const submitRunBtn = document.getElementById('submit-run-btn');

            if (user) {
                modPanel.classList.remove('hidden');
                loginContainer.classList.add('hidden');
                submitRunBtn.classList.remove('hidden');
            } else {
                modPanel.classList.add('hidden');
                loginContainer.classList.remove('hidden');
                submitRunBtn.classList.add('hidden');
                document.getElementById('submit-run-form-container').classList.add('hidden');
            }
        });

        // --- Event Listeners ---
        homeTab.addEventListener('click', () => {
            setActiveTab(homeTab);
            switchView('home-view');
        });

        modTab.addEventListener('click', () => {
            setActiveTab(modTab);
            switchView('mod-view');
        });

        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorMessage = document.getElementById('login-error-message');
            
            errorMessage.textContent = '';
            signInWithEmailAndPassword(auth, email, password)
                .catch(error => { errorMessage.textContent = "Email ou senha inválidos."; });
        });
        
        document.getElementById('logout-btn').addEventListener('click', () => { signOut(auth); });

        document.getElementById('submit-run-btn').addEventListener('click', () => {
            document.getElementById('submit-run-form-container').classList.toggle('hidden');
        });

        document.getElementById('submit-run-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const time = document.getElementById('run-time').value;
            submitRun(time);
        });

        // --- Inicialização ---
        displayGames();
    </script>
</body>
</html>
