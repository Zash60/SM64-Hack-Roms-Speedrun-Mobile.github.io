<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SM64 ROM Hacks Speedrun Mobile</title>
    <style>
        body { font-family: Arial, sans-serif; background: #000; color: #fff; margin: 0; padding: 0; }
        nav { background: #111; padding: 10px; display: flex; justify-content: space-around; }
        nav button { background: #333; color: #fff; border: none; padding: 10px; cursor: pointer; }
        nav button:hover { background: #555; }
        #content { padding: 20px; }
        .game-list ul { list-style: none; padding: 0; }
        .game-list li { margin: 10px 0; border: 1px solid #333; padding: 10px; display: flex; align-items: center; }
        .game-list img { width: 64px; height: 64px; margin-right: 10px; }
        .search-sort { margin-bottom: 20px; }
        .search-sort input, .search-sort select { margin-right: 10px; padding: 5px; background: #333; color: #fff; border: 1px solid #555; }
        .leaderboard h1, h2 { margin: 10px 0; }
        .cats-list ul { list-style: none; padding: 0; }
        .cats-list li { margin: 5px 0; }
        .cats-list a { color: #4af; text-decoration: none; }
        .vars { margin: 10px 0; }
        .vars label { display: block; margin: 5px 0; }
        .vars select { padding: 5px; background: #333; color: #fff; border: 1px solid #555; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { border: 1px solid #333; padding: 8px; text-align: left; }
        th { background: #111; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; }
        .modal-content { background: #333; margin: 15% auto; padding: 20px; width: 80%; max-width: 400px; }
        .modal input, .modal select, .modal textarea { width: 100%; margin: 5px 0; padding: 5px; background: #222; color: #fff; border: 1px solid #555; }
        .modal button { margin: 5px; padding: 10px; background: #4af; color: #fff; border: none; cursor: pointer; }
        .flag { width: 24px; height: 18px; }
        .login-form { max-width: 300px; margin: 50px auto; }
    </style>
</head>
<body>
    <nav id="nav"></nav>
    <div id="content"></div>
    <div id="submitModal" class="modal">
        <div class="modal-content">
            <h3>Submit Run</h3>
            <form id="submitForm">
                <input type="text" id="player" placeholder="Player Name" required>
                <input type="text" id="time" placeholder="Time (m:ss)" required>
                <input type="url" id="video" placeholder="Video URL" required>
                <input type="date" id="date" required>
                <input type="text" id="country" placeholder="Country Code (e.g. US)" >
                <div id="modalVars"></div>
                <button type="submit">Submit</button>
                <button type="button" onclick="closeModal()">Cancel</button>
            </form>
        </div>
    </div>
    <div id="editModal" class="modal">
        <div class="modal-content">
            <h3>Edit Run</h3>
            <form id="editForm">
                <input type="text" id="editPlayer" placeholder="Player Name" required>
                <input type="text" id="editTime" placeholder="Time (m:ss)" required>
                <input type="url" id="editVideo" placeholder="Video URL" required>
                <input type="date" id="editDate" required>
                <input type="text" id="editCountry" placeholder="Country Code (e.g. US)" >
                <div id="editModalVars"></div>
                <input type="hidden" id="editRunId">
                <button type="submit">Save</button>
                <button type="button" onclick="closeModal()">Cancel</button>
            </form>
        </div>
    </div>

    <script type="module">
        // Firebase Initialization
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, push, set, remove, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAsVYnWAq5aFOz9dIxHpGVWK8Mk64f01GU",
            authDomain: "sm64-hack-roms-speedrun-mobile.firebaseapp.com",
            databaseURL: "https://sm64-hack-roms-speedrun-mobile-default-rtdb.firebaseio.com",
            projectId: "sm64-hack-roms-speedrun-mobile",
            storageBucket: "sm64-hack-roms-speedrun-mobile.firebasestorage.app",
            messagingSenderId: "499101981060",
            appId: "1:499101981060:web:209dfe3f20866ef4f865d1"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        // Global variables
        let games = [];
        let currentSearch = '';
        let currentSort = 'alpha';
        const currentYear = new Date().getFullYear();

        // Force HTTPS helper
        function forceHttps(url) {
            return url.replace(/^http:/, 'https:');
        }

        // Caching functions
        function cacheData(key, data) {
            localStorage.setItem(key, JSON.stringify({ data, timestamp: Date.now() }));
        }

        function getCached(key, maxAge = 3600000) { // 1 hour
            const str = localStorage.getItem(key);
            if (!str) return null;
            const { data, timestamp } = JSON.parse(str);
            if (Date.now() - timestamp < maxAge) return data;
            localStorage.removeItem(key);
            return null;
        }

        // Fetch all games with pagination and caching
        async function fetchAllGames() {
            const cached = getCached('allGames');
            if (cached) return cached;
            let allGames = [];
            let url = 'https://www.speedrun.com/api/v1/series/sm64romhacks/games';
            while (url) {
                const res = await fetch(url);
                const json = await res.json();
                allGames = allGames.concat(json.data);
                const nextLink = json.pagination?.links?.find(l => l.rel === 'next');
                url = nextLink ? forceHttps(nextLink.uri) : null;
            }
            // Force HTTPS on assets and weblinks
            allGames.forEach(game => {
                if (game.assets) {
                    Object.values(game.assets).forEach(asset => {
                        if (asset.uri) asset.uri = forceHttps(asset.uri);
                    });
                }
                if (game.weblink) game.weblink = forceHttps(game.weblink);
            });
            cacheData('allGames', allGames);
            return allGames;
        }

        // Fetch game data (categories, levels) with caching
        async function getGameData(gameId) {
            const key = `gameData_${gameId}`;
            let data = getCached(key);
            if (!data) {
                const [catRes, levRes] = await Promise.all([
                    fetch(`https://www.speedrun.com/api/v1/games/${gameId}/categories`),
                    fetch(`https://www.speedrun.com/api/v1/games/${gameId}/levels`)
                ]);
                const cats = await catRes.json();
                const levels = await levRes.json();
                data = { categories: cats.data, levels: levels.data };
                cacheData(key, data);
            }
            return data;
        }

        // Fetch level categories with caching
        async function getLevelCategories(levelId) {
            const key = `levelCats_${levelId}`;
            let data = getCached(key);
            if (!data) {
                const res = await fetch(`https://www.speedrun.com/api/v1/levels/${levelId}/categories`);
                data = await res.json();
                cacheData(key, data);
            }
            return data.data;
        }

        // Fetch category variables
        async function getCategoryVariables(gameId, catId) {
            const key = `catVars_${gameId}_${catId}`;
            let data = getCached(key);
            if (!data) {
                const res = await fetch(`https://www.speedrun.com/api/v1/games/${gameId}/categories/${catId}/variables`);
                data = await res.json();
                cacheData(key, data);
            }
            return data;
        }

        // Format time from seconds
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            const ms = Math.floor((seconds % 1) * 1000);
            return `${mins}:${secs.toString().padStart(2, '0')}${ms ? `.${ms.toString().padStart(3, '0')}` : ''}`;
        }

        // Parse time string to seconds
        function parseTime(timeStr) {
            const parts = timeStr.split(':');
            if (parts.length !== 2) return 0;
            const mins = parseInt(parts[0], 10);
            const secPart = parts[1].split('.');
            const secs = parseInt(secPart[0], 10);
            const ms = secPart[1] ? parseInt(secPart[1], 10) / 1000 : 0;
            return mins * 60 + secs + ms;
        }

        // Render games list for home
        function renderGames(gamesList, search = '', sort = 'alpha') {
            let list = [...gamesList];
            if (search) {
                list = list.filter(g => g.names.international.toLowerCase().includes(search.toLowerCase()));
            }
            if (sort === 'recent') {
                list.sort((a, b) => b.released - a.released);
            } else if (sort === 'oldest') {
                list.sort((a, b) => a.released - b.released);
            } else {
                list.sort((a, b) => a.names.international.localeCompare(b.names.international));
            }
            const content = document.getElementById('content');
            content.innerHTML = `
                <div class="search-sort">
                    <input type="text" id="searchInput" placeholder="Search games" value="${search}" />
                    <select id="sortSelect">
                        <option value="alpha" ${sort === 'alpha' ? 'selected' : ''}>Alphabetical</option>
                        <option value="recent" ${sort === 'recent' ? 'selected' : ''}>Most Recent</option>
                        <option value="oldest" ${sort === 'oldest' ? 'selected' : ''}>Oldest</option>
                    </select>
                </div>
                <ul class="game-list">
                    ${list.map(game => `
                        <li>
                            <img src="${forceHttps(game.assets['cover-medium'].uri || '')}" alt="${game.names.international}" />
                            <div>
                                <h3>${game.names.international}</h3>
                                <p>Released: ${game.released}</p>
                                <p>${currentYear - game.released} years ago</p>
                                <a href="#game/${game.id}">View Leaderboards</a>
                            </div>
                        </li>
                    `).join('')}
                </ul>
            `;
            document.getElementById('searchInput').addEventListener('input', (e) => showHome(e.target.value, currentSort));
            document.getElementById('sortSelect').addEventListener('change', (e) => showHome(currentSearch, e.target.value));
        }

        // Show home page
        async function showHome(search = '', sort = 'alpha') {
            currentSearch = search;
            currentSort = sort;
            renderGames(games, search, sort);
        }

        // Show specific leaderboard
        async function showSpecificLeaderboard(gameId, catId, levelId, vars) {
            const content = document.getElementById('content');
            const game = games.find(g => g.id === gameId);
            if (!game) return content.innerHTML = '<p>Game not found.</p>';

            const gameData = await getGameData(gameId);
            let cats;
            let sectionTitle = 'Full Game';
            if (levelId) {
                const levelInfo = gameData.levels.find(l => l.id === levelId);
                if (!levelInfo) return content.innerHTML = '<p>Level not found.</p>';
                cats = await getLevelCategories(levelId);
                sectionTitle = levelInfo.name;
            } else {
                cats = gameData.categories.filter(c => c.type === 'per-game');
            }

            if (!catId) {
                // Show categories list for section
                content.innerHTML = `
                    <h1>${game.names.international}</h1>
                    <h2>${sectionTitle}</h2>
                    <ul class="cats-list">
                        ${cats.map(cat => {
                            const link = levelId ? `#game/${gameId}?level=${levelId}&cat=${cat.id}` : `#game/${gameId}?cat=${cat.id}`;
                            return `<li><a href="${link}">${cat.name}</a></li>`;
                        }).join('')}
                    </ul>
                    <button onclick="location.hash = ''">Back to Home</button>
                `;
                return;
            }

            // Show leaderboard for specific cat
            const catVarsData = await getCategoryVariables(gameId, catId);
            const catVars = catVarsData.data.filter(v => v.scope?.type === 'global'); // Global variables

            // Render variables dropdowns
            let varsHtml = '';
            catVars.forEach(v => {
                const currentVal = vars[v.id] || '';
                varsHtml += `
                    <label>${v.name}:
                        <select name="${v.id}" id="var_${v.id}">
                            ${v.values.data.map(val => `<option value="${val.id}" ${currentVal === val.id ? 'selected' : ''}>${val.label}</option>`).join('')}
                        </select>
                    </label>
                `;
            });

            // Update URL on var change
            const updateVars = () => {
                const newVars = { ...vars };
                catVars.forEach(v => {
                    const select = document.getElementById(`var_${v.id}`);
                    if (select) newVars[v.id] = select.value;
                });
                const p = new URLSearchParams();
                if (catId) p.set('cat', catId);
                if (levelId) p.set('level', levelId);
                Object.entries(newVars).forEach(([k, v]) => p.set(k, v));
                location.hash = `#game/${gameId}?${p.toString()}`;
            };
            catVars.forEach(v => {
                const select = document.getElementById(`var_${v.id}`);
                if (select) select.addEventListener('change', updateVars);
            });

            const catInfoRes = await fetch(`https://www.speedrun.com/api/v1/games/${gameId}/categories/${catId}`);
            const catInfo = await catInfoRes.json();
            const catName = catInfo.data.name;

            const levelName = levelId ? (await (await fetch(`https://www.speedrun.com/api/v1/levels/${levelId}`)).json()).data.name : '';

            content.innerHTML = `
                <h1>${game.names.international}</h1>
                <h2>${levelName ? levelName + ' - ' : ''}${catName}</h2>
                <div class="vars">${varsHtml}</div>
                <table id="runsTable">
                    <thead><tr><th>#</th><th>Player</th><th>Time</th><th>Date</th><th>Country</th><th>Video</th></tr></thead>
                    <tbody></tbody>
                </table>
                <button onclick="openSubmitModal('${gameId}', '${catId}', '${levelId || ''}', ${JSON.stringify(vars)})">Submit Run</button>
                <button onclick="location.hash = ''">Back to Home</button>
            `;

            // Real-time runs
            const lbPath = `games/${gameId}/leaderboards/${catId}/${levelId || 'full'}/runs`;
            const runsRef = ref(db, lbPath);
            onValue(runsRef, async (snap) => {
                let runData = snap.val();
                let runs = runData ? Object.entries(runData).map(([id, r]) => ({ id, ...r })) : [];
                runs = runs.filter(r => {
                    for (let [k, v] of Object.entries(vars)) {
                        if (r.variables?.[k] !== v) return false;
                    }
                    return true;
                }).sort((a, b) => (a.time || Infinity) - (b.time || Infinity));
                const tbody = document.querySelector('#runsTable tbody');
                tbody.innerHTML = runs.map((run, idx) => `
                    <tr>
                        <td>${idx + 1}</td>
                        <td>${run.player}</td>
                        <td>${formatTime(run.time)}</td>
                        <td>${new Date(run.date).toLocaleDateString()}</td>
                        <td>${run.country ? `<img class="flag" src="https://flagcdn.com/24x18/${run.country.toLowerCase()}.png" alt="${run.country}" /> ${run.country}` : ''}</td>
                        <td><a href="${run.video}" target="_blank">Watch</a></td>
                    </tr>
                `).join('');
            }, { onlyOnce: false });
        }

        // Modal functions
        function openSubmitModal(gameId, catId, levelId, varsObj) {
            const modal = document.getElementById('submitModal');
            const form = document.getElementById('submitForm');
            const modalVars = document.getElementById('modalVars');
            const vars = JSON.parse(varsObj); // From stringified
            let varsHtml = '';
            // Re-fetch vars for dropdowns in modal (simple, could cache)
            getCategoryVariables(gameId, catId).then(varData => {
                const catVars = varData.data.filter(v => v.scope?.type === 'global');
                catVars.forEach(v => {
                    const currentVal = vars[v.id] || '';
                    varsHtml += `
                        <label>${v.name}:
                            <select name="${v.id}">
                                ${v.values.data.map(val => `<option value="${val.id}" ${currentVal === val.id ? 'selected' : ''}>${val.label}</option>`).join('')}
                            </select>
                        </label>
                    `;
                });
                modalVars.innerHTML = varsHtml;
            });
            form.onsubmit = async (e) => {
                e.preventDefault();
                const player = document.getElementById('player').value;
                const timeStr = document.getElementById('time').value;
                const video = document.getElementById('video').value;
                const dateStr = document.getElementById('date').value;
                const country = document.getElementById('country').value;
                const modalVarsObj = {};
                modalVars.querySelectorAll('select').forEach(s => modalVarsObj[s.name] = s.value);
                const run = {
                    player,
                    time: parseTime(timeStr),
                    video,
                    date: new Date(dateStr).getTime(),
                    country,
                    variables: { ...vars, ...modalVarsObj },
                    submittedAt: Date.now()
                };
                // Fetch names
                const [gameRes, catRes] = await Promise.all([
                    fetch(`https://www.speedrun.com/api/v1/games/${gameId}`),
                    fetch(`https://www.speedrun.com/api/v1/games/${gameId}/categories/${catId}`)
                ]);
                const gameInfo = await gameRes.json();
                const catInfo = await catRes.json();
                run.gameId = gameId;
                run.catId = catId;
                run.levelId = levelId || null;
                run.gameName = gameInfo.data.names.international;
                run.catName = catInfo.data.name;
                if (levelId) {
                    const levRes = await fetch(`https://www.speedrun.com/api/v1/levels/${levelId}`);
                    const levInfo = await levRes.json();
                    run.levelName = levInfo.data.name;
                }
                // Submit to pending
                push(ref(db, 'pendingRuns'), run);
                closeModal();
                alert('Run submitted for moderation!');
            };
            modal.style.display = 'block';
        }

        function closeModal() {
            document.getElementById('submitModal').style.display = 'none';
            document.getElementById('editModal').style.display = 'none';
            document.getElementById('submitForm').reset();
            document.getElementById('editForm').reset();
        }

        // Mod functions
        async function approve(runId) {
            const runRef = ref(db, `pendingRuns/${runId}`);
            const snap = await get(runRef);
            const run = snap.val();
            if (!run) return;
            remove(runRef);
            const lbPath = `games/${run.gameId}/leaderboards/${run.catId}/${run.levelId || 'full'}/runs`;
            run.verified = true;
            run.approvedAt = Date.now();
            push(ref(db, lbPath), run);
        }

        async function reject(runId) {
            remove(ref(db, `pendingRuns/${runId}`));
        }

        async function deleteRun(runId) {
            remove(ref(db, `pendingRuns/${runId}`));
        }

        function openEditModal(runId, run) {
            document.getElementById('editRunId').value = runId;
            document.getElementById('editPlayer').value = run.player;
            document.getElementById('editTime').value = formatTime(run.time).split('.')[0]; // Approximate
            document.getElementById('editVideo').value = run.video;
            document.getElementById('editDate').value = new Date(run.date).toISOString().split('T')[0];
            document.getElementById('editCountry').value = run.country || '';
            // Vars similar to submit, but skip for simplicity or implement
            const modal = document.getElementById('editModal');
            document.getElementById('editForm').onsubmit = async (e) => {
                e.preventDefault();
                run.player = document.getElementById('editPlayer').value;
                run.time = parseTime(document.getElementById('editTime').value);
                run.video = document.getElementById('editVideo').value;
                run.date = new Date(document.getElementById('editDate').value).getTime();
                run.country = document.getElementById('editCountry').value;
                set(ref(db, `pendingRuns/${runId}`), run);
                closeModal();
            };
            modal.style.display = 'block';
        }

        function showMod() {
            const content = document.getElementById('content');
            const user = auth.currentUser;
            if (!user) {
                content.innerHTML = `
                    <div class="login-form">
                        <h2>Moderator Login</h2>
                        <form id="loginForm">
                            <input type="email" id="modEmail" placeholder="Email" required>
                            <input type="password" id="modPass" placeholder="Password" required>
                            <button type="submit">Login</button>
                            <button type="button" onclick="showSignup()">Signup</button>
                        </form>
                    </div>
                `;
                document.getElementById('loginForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const email = document.getElementById('modEmail').value;
                    const pass = document.getElementById('modPass').value;
                    try {
                        await signInWithEmailAndPassword(auth, email, pass);
                        showMod();
                    } catch (e) {
                        alert('Login failed: ' + e.message);
                    }
                });
                return;
            }
            // Show pending runs
            content.innerHTML = '<h2>Pending Runs Queue</h2><table id="pendingTable"><thead><tr><th>Game</th><th>Category</th><th>Level</th><th>Player</th><th>Time</th><th>Date</th><th>Video</th><th>Actions</th></tr></thead><tbody></tbody></table><button onclick="signOutMod()">Logout</button>';
            const pendingRef = ref(db, 'pendingRuns');
            onValue(pendingRef, (snap) => {
                let runs = snap.val() ? Object.entries(snap.val()).map(([id, r]) => ({ id, ...r })) : [];
                runs.sort((a, b) => b.submittedAt - a.submittedAt);
                const tbody = document.querySelector('#pendingTable tbody');
                tbody.innerHTML = runs.map(run => `
                    <tr>
                        <td>${run.gameName}</td>
                        <td>${run.catName}</td>
                        <td>${run.levelName || ''}</td>
                        <td>${run.player}</td>
                        <td>${formatTime(run.time)}</td>
                        <td>${new Date(run.date).toLocaleDateString()}</td>
                        <td><a href="${run.video}" target="_blank">Watch</a></td>
                        <td>
                            <button onclick="approve('${run.id}')">Approve</button>
                            <button onclick="reject('${run.id}')">Reject</button>
                            <button onclick="openEditModal('${run.id}', ${JSON.stringify(run)})">Edit</button>
                            <button onclick="deleteRun('${run.id}')">Delete</button>
                        </td>
                    </tr>
                `).join('');
            });
        }

        function showSignup() {
            const content = document.getElementById('content');
            content.innerHTML = `
                <div class="login-form">
                    <h2>Moderator Signup</h2>
                    <form id="signupForm">
                        <input type="email" id="signupEmail" placeholder="Email" required>
                        <input type="password" id="signupPass" placeholder="Password" required>
                        <button type="submit">Signup</button>
                        <button type="button" onclick="showMod()">Back to Login</button>
                    </form>
                </div>
            `;
            document.getElementById('signupForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('signupEmail').value;
                const pass = document.getElementById('signupPass').value;
                try {
                    await createUserWithEmailAndPassword(auth, email, pass);
                    alert('Signup successful! Please login.');
                    showMod();
                } catch (e) {
                    alert('Signup failed: ' + e.message);
                }
            });
        }

        function signOutMod() {
            signOut(auth);
            location.hash = '';
        }

        // Router
        function router() {
            const hash = location.hash.slice(1);
            const [pathPart, queryStr] = hash.split('?');
            const path = pathPart || '';
            const params = new URLSearchParams(queryStr || '');
            const gameId = path.split('/')[1];
            const catId = params.get('cat') || null;
            const levelId = params.get('level') || null;
            const vars = {};
            for (let [k, v] of params) {
                if (!['cat', 'level'].includes(k)) vars[k] = v;
            }
            document.getElementById('nav').innerHTML = `
                <button onclick="location.hash=''">Home</button>
                <button onclick="location.hash='mod'">Mod</button>
            `;
            if (path === '' || path === 'home') {
                showHome(currentSearch, currentSort);
            } else if (path === 'mod') {
                showMod();
            } else if (gameId && path.startsWith('game/')) {
                if (catId) {
                    showSpecificLeaderboard(gameId, catId, levelId, vars);
                } else {
                    showSpecificLeaderboard(gameId, null, levelId, vars);
                }
            }
        }

        // Init
        window.addEventListener('load', async () => {
            games = await fetchAllGames();
            router();
            window.addEventListener('hashchange', router);
            onAuthStateChanged(auth, router);
        });

        // Global functions for onclick
        window.approve = approve;
        window.reject = reject;
        window.deleteRun = deleteRun;
        window.openEditModal = openEditModal;
        window.closeModal = closeModal;
        window.showSignup = showSignup;
        window.signOutMod = signOutMod;
        window.showHome = showHome;
        window.openSubmitModal = openSubmitModal;
        window.forceHttps = forceHttps;
    </script>
</body>
</html>
