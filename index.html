<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SM64 Hack Roms Speedrun Mobile</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css">
    <style>
        :root {
            --bg-color: #1a1a1a; --surface-color: #2c2c2c; --primary-color: #4a90e2;
            --text-color: #e0e0e0; --text-secondary-color: #a0a0e0; --border-color: #444;
        }
        body { font-family: 'Roboto', sans-serif; margin: 0; background-color: var(--bg-color); color: var(--text-color); line-height: 1.6; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        a { color: var(--primary-color); text-decoration: none; cursor: pointer; }
        a:hover { text-decoration: underline; }
        header { background-color: var(--surface-color); padding: 1rem 0; border-bottom: 1px solid var(--border-color); position: sticky; top: 0; z-index: 999; }
        header .container { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;}
        header nav a { margin-left: 15px; font-weight: bold; }
        h1, h2, h3, h4 { font-weight: 700; border-bottom: 1px solid var(--border-color); padding-bottom: 8px; margin-top: 0; }
        h4 { font-size: 1.1em; margin-top: 20px; border-bottom: none; padding-bottom: 4px; border-left: 3px solid var(--primary-color); padding-left: 10px;}
        h5 { margin-bottom: 5px; color: var(--text-secondary-color); font-size: 0.9em; text-transform: uppercase; }
        .card { background-color: var(--surface-color); padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid var(--border-color); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select, textarea, button { font-family: 'Roboto', sans-serif; font-size: 1rem; }
        input, select, textarea { width: 100%; padding: 10px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-color); box-sizing: border-box; }
        input[type="checkbox"] { width: auto; margin-right: 10px; }
        select { appearance: none; -webkit-appearance: none; background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23a0a0a0%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E'); background-repeat: no-repeat; background-position: right .7em top 50%; background-size: .65em auto; padding-right: 2em; }
        .btn { padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; margin-right: 5px; transition: background-color 0.2s; }
        .btn:disabled { background-color: #555; cursor: not-allowed; }
        .btn-sm { padding: 5px 8px; font-size: 0.8em; }
        .btn-primary { background-color: var(--primary-color); color: #fff; }
        .btn-success { background-color: #28a745; color: #fff; }
        .btn-danger { background-color: #dc3545; color: #fff; }
        .btn-icon { background: none; border: none; color: var(--text-secondary-color); cursor: pointer; padding: 2px 6px; font-size: 1.1em; }
        .btn-icon:hover { color: var(--primary-color); }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); animation: fadeIn 0.3s; }
        .modal-content { background-color: var(--surface-color); margin: 5% auto; padding: 20px; border: 1px solid var(--border-color); width: 90%; max-width: 700px; border-radius: 8px; }
        .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; line-height: 1; }
        .page-container { padding: 2rem 0; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .games-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; }
        .game-card { display: block; background-color: var(--surface-color); border-radius: 8px; overflow: hidden; text-align: center; border: 1px solid var(--border-color); transition: transform 0.2s ease; position: relative; }
        .game-card:hover { transform: translateY(-5px); }
        .game-card img { width: 100%; height: 80px; object-fit: contain; display: block; background-color: #111; }
        .game-card-info { padding: 10px; }
        .game-card-info h3 { margin: 0; font-size: 0.8rem; font-weight: 400; color: var(--text-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; border: none; padding: 0;}
        .game-card-year { position: absolute; top: 5px; right: 5px; background-color: rgba(0,0,0,0.7); color: white; padding: 2px 5px; border-radius: 3px; font-size: 0.7em; font-weight: bold; }
        .leaderboard-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .leaderboard-nav { display: flex; gap: 20px; flex-wrap: wrap; align-items: flex-end; }
        .category-tabs { display: flex; gap: 5px; flex-wrap: wrap; }
        .tab { padding: 8px 15px; background-color: #333; border-radius: 5px; cursor: pointer; border: 1px solid var(--border-color); }
        .tab.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        .leaderboard-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        .leaderboard-table th, .leaderboard-table td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border-color); }
        .hack-item-header { display: flex; justify-content: space-between; align-items: center; width: 100%; gap: 10px; flex-wrap: wrap; }
        .hack-manage-details { display: none; width: 100%; padding: 15px; background-color: #222; border-top: 1px solid var(--border-color); margin-top: 10px; border-radius: 0 0 8px 8px; }
        .admin-list-item { display: flex; justify-content: space-between; align-items: center; gap: 10px; padding: 5px 0; border-bottom: 1px solid #333; flex-wrap: wrap; }
        .inline-edit-container { display: flex; align-items: center; gap: 5px; flex-grow: 1; }
        .inline-edit-container input { width: auto; flex-grow: 1; padding: 4px; font-size: 0.9em; background-color: #111; }
        .admin-add-form { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
        .admin-add-form input { flex-grow: 1; min-width: 150px; }
        .admin-add-form button { flex-shrink: 0; }
        .admin-sub-details { display: none; width: 100%; background-color: #111; padding: 10px; margin-top: 8px; border-radius: 4px; border-left: 2px solid var(--primary-color); }
        .controls-container { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; align-items: center;}
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid var(--primary-color); width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>SM64 Hack Roms Speedrun Mobile</h1>
            <nav><a id="home-link">Home</a><span id="auth-links-container"></span></nav>
        </div>
    </header>
    <main class="container">
        <div id="page-home" class="page-container">
            <h2>Games</h2>
            <div class="controls-container">
                <div class="form-group" style="flex-grow: 1;"><label for="hack-search-input">Search</label><input type="search" id="hack-search-input"></div>
                <div class="form-group"><label for="sort-by-select">Sort by</label>
                    <select id="sort-by-select">
                        <option value="name_asc">Name</option>
                        <option value="newest_released">Newest released</option>
                        <option value="oldest_released">Oldest released</option>
                    </select>
                </div>
            </div>
            <div id="games-grid"></div>
        </div>
        <div id="page-hack-details" class="page-container" style="display: none;">
            <div class="leaderboard-header">
                <h2 id="hack-details-title"></h2>
                <button id="submit-run-btn" class="btn btn-primary">Submit Run</button>
            </div>
            <div class="leaderboard-nav">
                <div class="form-group"><label>Leaderboard Type</label><select id="type-select"></select></div>
                <div id="level-select-container" class="form-group" style="display: none;"><label>Level / Stage</label><select id="level-select"></select></div>
            </div>
            <div id="leaderboard-content"></div>
        </div>
        <div id="page-admin" class="page-container" style="display: none;">
            <div id="login-section" style="display:none;">
                <h2>Moderator Login</h2>
                <form id="login-form" class="card">
                    <div class="form-group"><label>Email</label><input type="email" id="email" required></div>
                    <div class="form-group"><label>Password</label><input type="password" id="password" required></div>
                    <button type="submit" class="btn btn-primary">Login</button>
                    <p id="login-error" style="color: #e24a4a;"></p>
                </form>
            </div>
            <div id="admin-content" style="display: none;">
                <h2>Admin Panel</h2>
                <div class="card">
                    <h3>Add New Hack Rom</h3>
                    <form id="add-hack-form">
                        <div class="form-group"><label>Hack Name</label><input type="text" id="add-hack-name" required></div>
                        <div class="form-group"><label>Release Year</label><input type="number" id="add-hack-year" required></div>
                        <div class="form-group"><label>Cover Image URL</label><input type="url" id="add-hack-image" placeholder="https://example.com/image.png" required></div>
                        <button type="submit" class="btn btn-primary">Add Hack</button>
                    </form>
                </div>
                <div class="card">
                    <h3>Synchronization</h3>
                    <p>Fetch and add new SM64 Hack Roms, including categories and levels, directly from the official speedrun.com series.</p>
                    <button id="sync-src-btn" class="btn btn-primary">Sync with Speedrun.com</button>
                    <div class="form-group" style="margin-top: 10px;"><label style="display: inline-flex; align-items: center;"><input type="checkbox" id="force-sync-checkbox"> Force update (deletes all existing data)</label></div>
                    <div id="sync-status" style="margin-top: 10px;"></div>
                </div>
                <div class="card">
                    <h3>Existing Hack Roms</h3>
                    <div id="existing-hacks-list"></div>
                </div>
                <div class="card">
                    <h3>Review Pending Runs</h3>
                    <div id="pending-runs-list"></div>
                </div>
            </div>
        </div>
    </main>
    <div id="submit-run-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span><h3>Submit Run for <span id="submit-run-title"></span></h3>
            <form id="submit-run-form">
                <div class="form-group"><label>Player Name</label><input type="text" id="run-player" required></div>
                <div class="form-group"><label>Time (e.g., 1:23.456)</label><input type="text" id="run-time" required></div>
                <div class="form-group"><label>Date Achieved</label><input type="date" id="run-date" required></div>
                <div class="form-group"><label>Video Link</label><input type="url" id="run-video" required></div>
                <div id="run-submission-filters"></div>
                <button type="submit" class="btn btn-primary">Submit for Review</button>
            </form>
        </div>
    </div>

<script type="module">
    // Import Firebase SDKs
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getDatabase, ref, get, set, push, remove, update, query, orderByChild, equalTo, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyAsVYnWAq5aFOz9dIxHpGVWK8Mk64f01GU",
        authDomain: "sm64-hack-roms-speedrun-mobile.firebaseapp.com",
        databaseURL: "https://sm64-hack-roms-speedrun-mobile-default-rtdb.firebaseio.com",
        projectId: "sm64-hack-roms-speedrun-mobile",
        storageBucket: "sm64-hack-roms-speedrun-mobile.firebasestorage.app",
        messagingSenderId: "499101981060",
        appId: "1:499101981060:web:209dfe3f20866ef4f865d1"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    let state = { user: null };

    // Utility Functions
    function showPage(pageId) { document.querySelectorAll('.page-container').forEach(p => p.style.display = 'none'); document.getElementById(pageId).style.display = 'block'; }
    function parseTimeToMilliseconds(timeStr) { let t=0;if(timeStr.includes(':')){const parts=timeStr.split(':').reverse();t+=parseFloat(parts[0]||0)*1e3;t+=parseInt(parts[1]||0)*6e4;t+=parseInt(parts[2]||0)*36e5}else{timeStr.match(/(\d+)\s*h/)?.[1]&&(t+=parseInt(timeStr.match(/(\d+)\s*h/)[1])*36e5);timeStr.match(/(\d+)\s*m/)?.[1]&&(t+=parseInt(timeStr.match(/(\d+)\s*m/)[1])*6e4);timeStr.match(/(\d+(\.\d+)?)\s*s/)?.[1]&&(t+=parseFloat(timeStr.match(/(\d+(\.\d+)?)\s*s/)[1].replace(",","."))*1e3);timeStr.match(/(\d+)\s*ms/)?.[1]&&(t+=parseInt(timeStr.match(/(\d+)\s*ms/)[1]))}if(t===0&&!isNaN(parseFloat(timeStr)))t=parseFloat(timeStr)*1e3;return Math.round(t)}
    function formatTime(ms) { if (isNaN(ms) || ms < 0) return "Invalid Time"; const tS = Math.floor(ms / 1000); const h = Math.floor(tS / 3600); const m = Math.floor((tS % 3600) / 60); const s = tS % 60; const mmm = ms % 1000; const pM = String(m).padStart(2, '0'); const pS = String(s).padStart(2, '0'); const pMMM = String(mmm).padStart(3, '0'); if (h > 0) { return `${h}:${pM}:${pS}.${pMMM}`; } return `${m}:${pS}.${pMMM}`; }
    function createHTMLElement(tag, className, innerHTML = '') { const el = document.createElement(tag); if (className) el.className = className; el.innerHTML = innerHTML; return el; }
    function slugify(text) { return text.toString().toLowerCase().trim().replace(/\s+/g, '-').replace(/[^\w\-]+/g, '').replace(/\-\-+/g, '-').replace(/^-+/, '').replace(/-+$/, ''); }
    function snapshotToArray(snapshot) {
        const returnArr = [];
        snapshot.forEach(childSnapshot => {
            const item = childSnapshot.val();
            item.id = childSnapshot.key;
            returnArr.push(item);
        });
        return returnArr;
    }

    // --- Main Logic ---

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('home-link').onclick = (e) => { e.preventDefault(); window.location.hash = ''; showPage('page-home'); };
        onAuthStateChanged(auth, user => {
            state.user = user;
            updateAuthUI();
            handleRouteChange();
        });
    });
    
    function updateAuthUI() { /* ... unchanged ... */ }
    window.addEventListener('hashchange', handleRouteChange);
    function handleRouteChange() { /* ... unchanged ... */ }
    async function fetchAndDisplayHacks() { /* ... unchanged ... */ }
    document.getElementById('hack-search-input').addEventListener('input', (e) => { /* ... unchanged ... */ });
    document.getElementById('sort-by-select').addEventListener('change', fetchAndDisplayHacks);
    async function showHackDetails(slug) { /* ... unchanged ... */ }
    async function renderLeaderboardUI() { /* ... unchanged ... */ }
    async function renderVariablesAndRuns(category) { /* ... unchanged ... */ }
    async function fetchAndDisplayLeaderboard() { /* ... unchanged ... */ }
    function initAdminPage() { /* ... unchanged ... */ }
    async function handleAddHack(e) { /* ... unchanged ... */ }
    async function loadAdminData() { /* ... unchanged ... */ }
    async function loadExistingHacksAdmin() { /* ... unchanged ... */ }
    async function loadPendingRuns() { /* ... unchanged ... */ }
    async function updateRunStatus(runId, status) { /* ... unchanged ... */ }
    async function deleteRun(runId) { /* ... unchanged ... */ }
    
    const submitRunModal = document.getElementById('submit-run-modal');
    document.getElementById('submit-run-btn').onclick = () => { /* ... unchanged ... */ };
    document.querySelector('#submit-run-modal .close-button').onclick = () => submitRunModal.style.display = 'none';
    document.getElementById('submit-run-form').onsubmit = async (e) => { /* ... unchanged ... */ };
    
    // --- START OF REWRITTEN SYNC FUNCTION ---

    async function fetchAllSRCGames(offset = 0, allGames = []) {
        const url = `https://www.speedrun.com/api/v1/series/sm64romhacks/games?max=200&offset=${offset}`;
        try {
            const res = await fetch(url);
            if (res.status === 404) return allGames;
            if (!res.ok) throw new Error(`API fetch failed with status ${res.status}`);
            const data = await res.json();
            if (data.data.length === 0) return allGames;
            allGames.push(...data.data);
            if (data.pagination.size === 200) {
                return fetchAllSRCGames(offset + 200, allGames);
            }
            return allGames;
        } catch (error) {
            console.error("Failed to fetch games from SRC:", error);
            throw error;
        }
    }

    async function syncWithSpeedrunCom() {
        const statusDiv = document.getElementById('sync-status');
        const syncBtn = document.getElementById('sync-src-btn');
        const force = document.getElementById('force-sync-checkbox').checked;
        syncBtn.disabled = true;
        statusDiv.innerHTML = '<div class="loader"></div>Starting sync...';

        if (force && !confirm("This will DELETE ALL DATA from the database. This cannot be undone. Are you absolutely sure?")) {
            statusDiv.innerHTML = "Sync cancelled by user.";
            syncBtn.disabled = false;
            return;
        }

        try {
            if (force) {
                const pathsToDelete = ['runs', 'stars', 'options', 'variables', 'levels', 'categories', 'hacks'];
                for (const path of pathsToDelete) {
                    statusDiv.innerHTML = `<div class="loader"></div>Deleting old data from: <strong>${path}</strong>...`;
                    await remove(ref(db, path));
                }
            }

            statusDiv.innerHTML = '<div class="loader"></div>Fetching all games from speedrun.com... This may take a moment.';
            const allGames = await fetchAllSRCGames();

            for (const [i, game] of allGames.entries()) {
                const gameName = game.names.international;
                statusDiv.innerHTML = `<div class="loader"></div>(${i + 1}/${allGames.length}) Processing: <strong>${gameName}</strong>...`;

                if (!force) {
                    const q = query(ref(db, 'hacks'), orderByChild('srcId'), equalTo(game.id));
                    const existingSnap = await get(q);
                    if (existingSnap.exists()) {
                        console.log(`Skipping existing hack: ${gameName}`);
                        continue;
                    }
                }

                const dRes = await fetch(`https://www.speedrun.com/api/v1/games/${game.id}?embed=categories,levels,variables`);
                if (!dRes.ok) {
                    console.warn(`Could not fetch details for ${gameName}. Skipping.`);
                    continue;
                }
                const details = (await dRes.json()).data;
                
                // 1. Insert Hack
                const newHackData = {
                    name: gameName,
                    year: details.released || null,
                    imageUrl: details.assets['cover-large']?.uri || '',
                    slug: slugify(gameName),
                    order: i,
                    srcId: details.id,
                    created_at: details.created || new Date().toISOString()
                };
                const newHackRef = await push(ref(db, 'hacks'), newHackData);
                const newHackId = newHackRef.key;

                // 2. Insert Categories
                for (const [idx, c] of (details.categories?.data || []).entries()) {
                    await push(ref(db, 'categories'), {
                        name: c.name,
                        type: c.type === 'per-level' ? (c.name.toLowerCase().includes('rta') ? 'level_rta' : 'level_singlestar') : 'fullgame',
                        order: idx,
                        hack_id: newHackId
                    });
                }

                // 3. Insert Variables and their Options
                for (const v of (details.variables?.data || [])) {
                    if (v.scope.type !== 'full-game' || !v['is-for-all']) continue;
                    
                    const newVarRef = await push(ref(db, 'variables'), { name: v.name, order: i, srcId: v.id, hack_id: newHackId });
                    if (newVarRef && v.values.values) {
                        for (const [o_idx, [id, val]] of Object.entries(v.values.values).entries()) {
                            await push(ref(db, 'options'), { name: val.label, order: o_idx, srcId: id, variable_id: newVarRef.key });
                        }
                    }
                }

                // 4. Insert Levels and their Stars
                for (const [l_idx, level] of (details.levels?.data || []).entries()) {
                    const newLevelRef = await push(ref(db, 'levels'), { name: level.name, order: l_idx, srcId: level.id, hack_id: newHackId });
                    
                    const starVar = (details.variables?.data || []).find(v => v.scope.type === 'single-level' && v.scope.level === level.id);
                    if (newLevelRef && starVar?.values.values) {
                         for (const [s_idx, [id, val]] of Object.entries(starVar.values.values).entries()) {
                            await push(ref(db, 'stars'), { name: val.label, order: s_idx, srcId: id, level_id: newLevelRef.key });
                        }
                    }
                }
            }

            statusDiv.innerHTML = `<strong style="color: #28a745;">Sync complete! Processed ${allGames.length} games.</strong>`;
            await loadAdminData(); // Refresh admin panel data
            await fetchAndDisplayHacks(); // Refresh home page data
        } catch (error) {
            console.error("Sync Error:", error);
            statusDiv.innerHTML = `<strong style="color: #dc3545;">Sync Error:</strong> ${error.message}`;
        } finally {
            syncBtn.disabled = false;
        }
    }
    // --- END OF REWRITTEN SYNC FUNCTION ---

</script>
</body>
</html>
